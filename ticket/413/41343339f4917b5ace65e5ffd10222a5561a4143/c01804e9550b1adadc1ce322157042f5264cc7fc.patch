Index: include/wx/msw/debughlp.h
===================================================================
--- include/wx/msw/debughlp.h	(ÉäÉrÉWÉáÉì 73805)
+++ include/wx/msw/debughlp.h	(çÏã∆ÉRÉsÅ[)
@@ -2,7 +2,7 @@
 // Name:        wx/msw/debughlp.h
 // Purpose:     wraps dbghelp.h standard file
 // Author:      Vadim Zeitlin
-// Modified by:
+// Modified by: Suzumizaki-kimitaka 2013-04-10
 // Created:     2005-01-08 (extracted from msw/crashrpt.cpp)
 // RCS-ID:      $Id$
 // Copyright:   (c) 2003-2005 Vadim Zeitlin <vadim@wxwindows.org>
@@ -43,6 +43,54 @@
 
 #if wxUSE_DBGHELP
 
+/*
+
+The table below shows which functions are exported by dbghelp.dll.
+On 64 bit Windows, it looks no difference between 32bit dll and 
+64bit one.
+Vista-64 and Win8-64 looks same, but in fact, "Ex" and "ExW"
+versions are exist only in Windows 8.
+
+Make sure SymGetLineFromAddrW and EnumerateLoadedModulesW DON'T 
+exists.
+
+functions | Windows     | XP-32 Vista-64 Win8-64
+SymEnumSymbolsW            n/a     v       v
+SymFromAddrW               n/a     v       v
+SymInitializeW             n/a     v       v
+
+SymEnumSymbols              v      v       v
+SymFromAddr                 v      v       v
+SymInitialize               v      v       v
+
+SymGetLineFromAddrW64      n/a     v       v
+SymGetLineFromAddr64        v      v       v
+SymGetLineFromAddrW        n/a    n/a     n/a
+SymGetLineFromAddr          v      v       v
+
+EnumerateLoadedModulesW64  n/a     v       v
+EnumerateLoadedModules64    v      v       v
+EnumerateLoadedModulesW    n/a    n/a     n/a
+EnumerateLoadedModules      v      v       v
+
+*/
+
+#ifdef UNICODE
+#define wxPENUMLOADED_MODULES_CALLBACK64 PENUMLOADED_MODULES_CALLBACKW64
+#define wxPSYMBOL_INFO PSYMBOL_INFOW
+#define wxSYMBOL_INFO SYMBOL_INFOW
+#define wxPIMAGEHLP_LINE PIMAGEHLP_LINEW64
+#define wxIMAGEHLP_LINE IMAGEHLP_LINEW64
+#define wxPSYM_ENUMERATESYMBOLS_CALLBACK PSYM_ENUMERATESYMBOLS_CALLBACKW
+#else
+#define wxPENUMLOADED_MODULES_CALLBACK64 PENUMLOADED_MODULES_CALLBACK64
+#define wxPSYMBOL_INFO PSYMBOL_INFO
+#define wxSYMBOL_INFO SYMBOL_INFO
+#define wxPIMAGEHLP_LINE PIMAGEHLP_LINE64
+#define wxIMAGEHLP_LINE IMAGEHLP_LINE64
+#define wxPSYM_ENUMERATESYMBOLS_CALLBACK PSYM_ENUMERATESYMBOLS_CALLBACK
+#endif
+
 // ----------------------------------------------------------------------------
 // wxDbgHelpDLL: dynamically load dbghelp.dll functions
 // ----------------------------------------------------------------------------
@@ -142,31 +190,47 @@
     // function types
     typedef DWORD (WINAPI *SymGetOptions_t)();
     typedef DWORD (WINAPI *SymSetOptions_t)(DWORD);
-    typedef BOOL (WINAPI *SymInitialize_t)(HANDLE, LPSTR, BOOL);
     typedef BOOL (WINAPI *StackWalk_t)(DWORD, HANDLE, HANDLE, LPSTACKFRAME,
                                        LPVOID, PREAD_PROCESS_MEMORY_ROUTINE,
                                        PFUNCTION_TABLE_ACCESS_ROUTINE,
                                        PGET_MODULE_BASE_ROUTINE,
                                        PTRANSLATE_ADDRESS_ROUTINE);
-    typedef BOOL (WINAPI *SymFromAddr_t)(HANDLE, DWORD64, PDWORD64, PSYMBOL_INFO);
     typedef LPVOID (WINAPI *SymFunctionTableAccess_t)(HANDLE, DWORD_PTR);
     typedef DWORD_PTR (WINAPI *SymGetModuleBase_t)(HANDLE, DWORD_PTR);
-    typedef BOOL (WINAPI *SymGetLineFromAddr_t)(HANDLE, DWORD_PTR,
-                                                PDWORD, PIMAGEHLP_LINE);
     typedef BOOL (WINAPI *SymSetContext_t)(HANDLE, PIMAGEHLP_STACK_FRAME,
                                            PIMAGEHLP_CONTEXT);
-    typedef BOOL (WINAPI *SymEnumSymbols_t)(HANDLE, ULONG64, PCSTR,
-                                            PSYM_ENUMERATESYMBOLS_CALLBACK, PVOID);
     typedef BOOL (WINAPI *SymGetTypeInfo_t)(HANDLE, DWORD64, ULONG,
                                             IMAGEHLP_SYMBOL_TYPE_INFO, PVOID);
     typedef BOOL (WINAPI *SymCleanup_t)(HANDLE);
-    typedef BOOL (WINAPI *EnumerateLoadedModules_t)(HANDLE, PENUMLOADED_MODULES_CALLBACK, PVOID);
     typedef BOOL (WINAPI *MiniDumpWriteDump_t)(HANDLE, DWORD, HANDLE,
                                                MINIDUMP_TYPE,
                                                CONST PMINIDUMP_EXCEPTION_INFORMATION,
                                                CONST PMINIDUMP_USER_STREAM_INFORMATION,
                                                CONST PMINIDUMP_CALLBACK_INFORMATION);
 
+    typedef BOOL (WINAPI *EnumerateLoadedModules_t)(HANDLE, PENUMLOADED_MODULES_CALLBACK, PVOID);
+    typedef BOOL (WINAPI *SymGetLineFromAddr_t)(HANDLE, DWORD, PDWORD, PIMAGEHLP_LINE);
+
+    typedef BOOL (WINAPI *EnumerateLoadedModules64_t)(HANDLE, PENUMLOADED_MODULES_CALLBACK64, PVOID);
+    typedef BOOL (WINAPI *SymInitialize_t)(HANDLE, LPCSTR, BOOL);
+    typedef BOOL (WINAPI *SymFromAddr_t)(HANDLE, DWORD64, PDWORD64, PSYMBOL_INFO);
+    typedef BOOL (WINAPI *SymGetLineFromAddr64_t)(HANDLE, DWORD64, PDWORD, PIMAGEHLP_LINE64);
+    typedef BOOL (WINAPI *SymEnumSymbols_t)(HANDLE, ULONG64, PCSTR,
+                                            PSYM_ENUMERATESYMBOLS_CALLBACK, const PVOID);
+
+    typedef BOOL (WINAPI *EnumerateLoadedModulesW64_t)(HANDLE, PENUMLOADED_MODULES_CALLBACKW64, PVOID);
+    typedef BOOL (WINAPI *SymInitializeW_t)(HANDLE, LPCWSTR, BOOL);
+    typedef BOOL (WINAPI *SymFromAddrW_t)(HANDLE, DWORD64, PDWORD64, PSYMBOL_INFOW);
+    typedef BOOL (WINAPI *SymGetLineFromAddrW64_t)(HANDLE, DWORD64, PDWORD, PIMAGEHLP_LINEW64);
+    typedef BOOL (WINAPI *SymEnumSymbolsW_t)(HANDLE, ULONG64, PCWSTR,
+                                             PSYM_ENUMERATESYMBOLS_CALLBACKW, const PVOID);
+    
+    static BOOL EnumerateLoadedModulesT(HANDLE, wxPENUMLOADED_MODULES_CALLBACK64, PVOID);
+    static BOOL SymInitializeT(HANDLE, LPCTSTR, BOOL);
+    static BOOL SymFromAddrT(HANDLE, DWORD64, PDWORD64, wxPSYMBOL_INFO);
+    static BOOL SymGetLineFromAddrT(HANDLE, DWORD64, PDWORD, wxPIMAGEHLP_LINE);
+    static BOOL SymEnumSymbolsT(HANDLE, ULONG64, PCTSTR, wxPSYM_ENUMERATESYMBOLS_CALLBACK, const PVOID);
+
     // The macro called by wxDO_FOR_ALL_SYM_FUNCS() below takes 2 arguments:
     // the name of the function in the program code, which never has "64"
     // suffix, and the name of the function in the DLL which can have "64"
@@ -175,7 +239,6 @@
     #define wxSYM_CALL(what, name)  what(name, name)
 #if defined(_M_AMD64)
     #define wxSYM_CALL_64(what, name)  what(name, name ## 64)
-
     // Also undo all the "helpful" definitions done by imagehlp.h that map 32
     // bit functions to 64 bit ones, we don't need this as we do it ourselves.
     #undef StackWalk
@@ -187,27 +250,57 @@
     #define wxSYM_CALL_64(what, name)  what(name, name)
 #endif
 
-    #define wxDO_FOR_ALL_SYM_FUNCS(what)                                      \
-        wxSYM_CALL_64(what, StackWalk);                                       \
-        wxSYM_CALL_64(what, SymFunctionTableAccess);                          \
-        wxSYM_CALL_64(what, SymGetModuleBase);                                \
-        wxSYM_CALL_64(what, SymGetLineFromAddr);                              \
-        wxSYM_CALL_64(what, EnumerateLoadedModules);                          \
-                                                                              \
-        wxSYM_CALL(what, SymGetOptions);                                      \
-        wxSYM_CALL(what, SymSetOptions);                                      \
-        wxSYM_CALL(what, SymInitialize);                                      \
-        wxSYM_CALL(what, SymFromAddr);                                        \
-        wxSYM_CALL(what, SymSetContext);                                      \
-        wxSYM_CALL(what, SymEnumSymbols);                                     \
-        wxSYM_CALL(what, SymGetTypeInfo);                                     \
-        wxSYM_CALL(what, SymCleanup);                                         \
+    #define wxSYM_CALL_ALWAYS_W(what, name)  what(name ## W, name ## W)
+
+    #define wxSYM_CALL_ALTERNATIVES(what, name)                \
+        what(name, name);                                      \
+        what(name ## 64, name ## 64);                          \
+        what(name ## W64, name ## W64)
+
+    #define wxDO_FOR_ALL_SYM_FUNCS_REQUIRED_PUBLIC(what)       \
+        wxSYM_CALL_64(what, StackWalk);                        \
+        wxSYM_CALL_64(what, SymFunctionTableAccess);           \
+        wxSYM_CALL_64(what, SymGetModuleBase);                 \
+                                                               \
+        wxSYM_CALL(what, SymGetOptions);                       \
+        wxSYM_CALL(what, SymSetOptions);                       \
+        wxSYM_CALL(what, SymSetContext);                       \
+        wxSYM_CALL(what, SymGetTypeInfo);                      \
+        wxSYM_CALL(what, SymCleanup);                          \
         wxSYM_CALL(what, MiniDumpWriteDump)
 
+    #define wxDO_FOR_ALL_SYM_FUNCS_REQUIRED_PRIVATE(what)      \
+        wxSYM_CALL(what, SymInitialize);                       \
+        wxSYM_CALL(what, SymFromAddr);                         \
+        wxSYM_CALL(what, SymEnumSymbols)
+    
+    #define wxDO_FOR_ALL_SYM_FUNCS_REQUIRED(what)              \
+        wxDO_FOR_ALL_SYM_FUNCS_REQUIRED_PRIVATE(what);         \
+        wxDO_FOR_ALL_SYM_FUNCS_REQUIRED_PUBLIC(what)
+
+    // Alternation will work when the following functions are not found,
+    // therefore they are not included in REQUIRED version.
+    #define wxDO_FOR_ALL_SYM_FUNCS_OPTIONAL(what)              \
+        wxSYM_CALL_ALTERNATIVES(what, SymGetLineFromAddr);     \
+        wxSYM_CALL_ALTERNATIVES(what, EnumerateLoadedModules); \
+        wxSYM_CALL_ALWAYS_W(what, SymInitialize);              \
+        wxSYM_CALL_ALWAYS_W(what, SymFromAddr);                \
+        wxSYM_CALL_ALWAYS_W(what, SymEnumSymbols)
+
+    #define wxDO_FOR_ALL_SYM_FUNCS(what)                       \
+        wxDO_FOR_ALL_SYM_FUNCS_REQUIRED(what);                 \
+        wxDO_FOR_ALL_SYM_FUNCS_OPTIONAL(what)
+    
     #define wxDECLARE_SYM_FUNCTION(func, name) static func ## _t func
 
-    wxDO_FOR_ALL_SYM_FUNCS(wxDECLARE_SYM_FUNCTION);
+    wxDO_FOR_ALL_SYM_FUNCS_REQUIRED_PUBLIC(wxDECLARE_SYM_FUNCTION);
 
+private:
+    wxDO_FOR_ALL_SYM_FUNCS_REQUIRED_PRIVATE(wxDECLARE_SYM_FUNCTION);
+    wxDO_FOR_ALL_SYM_FUNCS_OPTIONAL(wxDECLARE_SYM_FUNCTION);
+
+public:
+
     #undef wxDECLARE_SYM_FUNCTION
 
     // load all functions from DLL, return true if ok
@@ -220,10 +313,10 @@
     static void LogError(const wxChar *func);
 
     // return textual representation of the value of given symbol
-    static wxString DumpSymbol(PSYMBOL_INFO pSymInfo, void *pVariable);
+    static wxString DumpSymbol(wxPSYMBOL_INFO pSymInfo, void *pVariable);
 
     // return the name of the symbol with given type index
-    static wxString GetSymbolName(PSYMBOL_INFO pSymInfo);
+    static wxString GetSymbolName(wxPSYMBOL_INFO pSymInfo);
 
 private:
     // dereference the given symbol, i.e. return symbol which is not a
@@ -233,17 +326,20 @@
     // dereferenced the symbol
     //
     // return the tag of the dereferenced symbol
-    static SymbolTag DereferenceSymbol(PSYMBOL_INFO pSymInfo, void **ppData);
+    static SymbolTag DereferenceSymbol(wxPSYMBOL_INFO pSymInfo, void **ppData);
 
-    static wxString DumpField(PSYMBOL_INFO pSymInfo,
+    static wxString DumpField(wxPSYMBOL_INFO pSymInfo,
                               void *pVariable,
                               unsigned level);
 
     static wxString DumpBaseType(BasicType bt, DWORD64 length, void *pVariable);
 
-    static wxString DumpUDT(PSYMBOL_INFO pSymInfo,
+    static wxString DumpUDT(wxPSYMBOL_INFO pSymInfo,
                             void *pVariable,
                             unsigned level = 0);
+
+    static bool BindDbgHelpFunctions(const wxDynamicLibrary& dllDbgHelp);
+    static bool DoInit();
 };
 
 #endif // wxUSE_DBGHELP
Index: include/wx/msw/stackwalk.h
===================================================================
--- include/wx/msw/stackwalk.h	(ÉäÉrÉWÉáÉì 73805)
+++ include/wx/msw/stackwalk.h	(çÏã∆ÉRÉsÅ[)
@@ -2,7 +2,7 @@
 // Name:        wx/msw/stackwalk.h
 // Purpose:     wxStackWalker for MSW
 // Author:      Vadim Zeitlin
-// Modified by:
+// Modified by: Suzumizaki-kimitaka 2013-04-09
 // Created:     2005-01-08
 // RCS-ID:      $Id$
 // Copyright:   (c) 2005 Vadim Zeitlin <vadim@wxwindows.org>
@@ -20,6 +20,7 @@
 
 // and these in dbghelp.h
 struct _SYMBOL_INFO;
+struct _SYMBOL_INFOW;
 
 // ----------------------------------------------------------------------------
 // wxStackFrame
@@ -53,7 +54,11 @@
     GetParam(size_t n, wxString *type, wxString *name, wxString *value) const;
 
     // callback used by OnGetParam(), don't call directly
-    void OnParam(_SYMBOL_INFO *pSymInfo);
+#ifdef UNICODE
+    void OnParam(_SYMBOL_INFOW * pSymInfo);
+#else
+    void OnParam(_SYMBOL_INFO * pSymInfo);
+#endif
 
 protected:
     virtual void OnGetName();
Index: samples/except/except.bkl
===================================================================
--- samples/except/except.bkl	(ÉäÉrÉWÉáÉì 73805)
+++ samples/except/except.bkl	(çÏã∆ÉRÉsÅ[)
@@ -6,7 +6,8 @@
     <include file="../../build/bakefiles/common_samples.bkl"/>
 
     <exe id="except" template="wx_sample" template_append="wx_append">
-        <sources>except.cpp</sources>
+        <sources>except.cpp except_utf8.cpp</sources>
+        <headers>except_utf8.h</headers>
         <wx-lib>core</wx-lib>
         <wx-lib>base</wx-lib>
     </exe>
Index: samples/except/except.cpp
===================================================================
--- samples/except/except.cpp	(ÉäÉrÉWÉáÉì 73805)
+++ samples/except/except.cpp	(çÏã∆ÉRÉsÅ[)
@@ -2,7 +2,7 @@
 // Name:        samples/except/except.cpp
 // Purpose:     shows how C++ exceptions can be used in wxWidgets
 // Author:      Vadim Zeitlin
-// Modified by:
+// Modified by: Suzumizaki-kimitaka 2013-04-08
 // Created:     2003-09-17
 // RCS-ID:      $Id$
 // Copyright:   (c) 2003-2005 Vadim Zeitlin
@@ -48,6 +48,8 @@
     #include "wx/thread.h"
 #endif
 
+#include "except_utf8.h"
+
 // ----------------------------------------------------------------------------
 // resources
 // ----------------------------------------------------------------------------
@@ -113,6 +115,7 @@
     void OnQuit(wxCommandEvent& event);
     void OnAbout(wxCommandEvent& event);
     void OnDialog(wxCommandEvent& event);
+    void OnDialogUnicode(wxCommandEvent& event);
 
     void OnThrowInt(wxCommandEvent& event);
     void OnThrowString(wxCommandEvent& event);
@@ -198,6 +201,7 @@
     Except_ShowAssertInThread,
 #endif // wxUSE_THREADS
     Except_Dialog,
+    Except_Dialog_Unicode,
 
     Except_Quit = wxID_EXIT,
     Except_About = wxID_ABOUT
@@ -215,6 +219,7 @@
     EVT_MENU(Except_About, MyFrame::OnAbout)
     EVT_MENU(Except_Dialog, MyFrame::OnDialog)
     EVT_MENU(Except_ThrowInt, MyFrame::OnThrowInt)
+    EVT_MENU(Except_Dialog_Unicode, MyFrame::OnDialogUnicode)
     EVT_MENU(Except_ThrowString, MyFrame::OnThrowString)
     EVT_MENU(Except_ThrowObject, MyFrame::OnThrowObject)
     EVT_MENU(Except_ThrowUnhandled, MyFrame::OnThrowUnhandled)
@@ -349,6 +354,8 @@
     // create a menu bar
     wxMenu *menuFile = new wxMenu;
     menuFile->Append(Except_Dialog, wxT("Show &dialog\tCtrl-D"));
+    menuFile->Append(Except_Dialog_Unicode,
+                     wxT("Show dialog using &Unicode named class\tCtrl-U"));
     menuFile->AppendSeparator();
     menuFile->Append(Except_ThrowInt, wxT("Throw an &int\tCtrl-I"));
     menuFile->Append(Except_ThrowString, wxT("Throw a &string\tCtrl-S"));
@@ -427,6 +434,29 @@
     }
 }
 
+void MyFrame::OnDialogUnicode(wxCommandEvent& WXUNUSED(event))
+{
+#if STACKTRACE_CAN_INCLUDE_UNICODE
+    try
+    {
+        wxDialog* dlg = GenerateDialogUnicode(this);
+
+        dlg->ShowModal();
+    }
+    catch ( ... )
+    {
+        wxLogWarning(wxT("An exception in Unicode Version Dialog"));
+
+        Destroy();
+        throw;
+    }
+#else
+    wxMessageBox(
+       wxT("Please define STACKTRACE_CAN_INCLUDE_UNICODE as 1 and rebuild."));
+#endif
+}
+
+
 void MyFrame::OnThrowInt(wxCommandEvent& WXUNUSED(event))
 {
     throw -17;
@@ -546,4 +576,3 @@
 {
     DoCrash();
 }
-
Index: samples/except/except.dsp
===================================================================
--- samples/except/except.dsp	(ÉäÉrÉWÉáÉì 73805)
+++ samples/except/except.dsp	(çÏã∆ÉRÉsÅ[)
@@ -31,7 +31,7 @@
 MTL=midl.exe
 RSC=rc.exe
 
-!IF  "$(CFG)" == "except - Win32 DLL Release"
+!IF  "$(CFG)" == "except - Win32 DLL Release"
 
 # PROP BASE Use_MFC 0
 # PROP BASE Use_Debug_Libraries 1
@@ -148,9 +148,21 @@
 # End Source File
 # Begin Source File
 
+SOURCE=.\except_utf8.cpp
+# End Source File
+# Begin Source File
+
 SOURCE=.\..\..\samples\sample.rc
 # End Source File
 # End Group
+# Begin Group "Header Files"
+
+# PROP Default_Filter ""
+# Begin Source File
+
+SOURCE=.\except_utf8.h
+# End Source File
+# End Group
 # End Target
 # End Project
 
Index: samples/except/except_utf8.cpp
===================================================================
--- samples/except/except_utf8.cpp	(ÉäÉrÉWÉáÉì 0)
+++ samples/except/except_utf8.cpp	(çÏã∆ÉRÉsÅ[)
@@ -0,0 +1,209 @@
+Ôªø/////////////////////////////////////////////////////////////////////////////
+// Name:        samples/except/except_utf8.cpp
+// Purpose:     
+// Author:      Suzumizaki-kimitaka
+// Modified by: 
+// Created:     2013-04-11
+// RCS-ID:      
+// Copyright:   (C) Suzumizaki-kimitaka
+// Licence:     wxWindows licence
+/////////////////////////////////////////////////////////////////////////////
+
+/*
+
+C++ specification allows non-ASCII named classes, variables, functions, etc.
+and this file includes Unicode characters for own purpose.
+
+Currently this file is saved as UTF-8 with Byte Order Mark.
+If the BOM doesn't exist, Visual C++ may treat source texts as local not UTF.
+
+Old versions of wxMSW can't treat non-ASCII named identifiers inside stack
+tracing. Because ill versions call wxString::FromAscii with such identifiers
+and assertion-stop raised by FromAscii throws away the information we really
+need. Additionally to say, Ill versions used only MBCS functions implemented
+in dbghelp.dll
+
+Try assertion stop and check the dialog shows correctly the names of classes
+and functions in Unicode.
+
+When you uses outdated dbghelp.dll, or MBCS build that not support the class
+name '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', you can only check avoiding multi assertion stops.
+
+*/
+
+// ============================================================================
+// declarations
+// ============================================================================
+
+// ----------------------------------------------------------------------------
+// headers
+// ----------------------------------------------------------------------------
+
+// For compilers that support precompilation, includes "wx/wx.h".
+#include "wx/wxprec.h"
+
+#ifdef __BORLANDC__
+    #pragma hdrstop
+#endif
+
+#include "except_utf8.h"
+#if STACKTRACE_CAN_INCLUDE_UNICODE
+
+#ifndef WX_PRECOMP
+    #include "wx/button.h"
+    #include "wx/sizer.h"
+    #include "wx/stattext.h"
+    #include "wx/dynlib.h"
+    #include "wx/msgdlg.h"
+#endif
+
+// ----------------------------------------------------------------------------
+// private classes
+// ----------------------------------------------------------------------------
+
+// named 'Thai language, Japanese, Hindi' only for test purpose
+class ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä : public wxDialog
+{
+public:
+    ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä(wxFrame *parent);
+
+    // event handlers
+    void OnShowAssert(wxCommandEvent& event);
+    void OnThrowObject(wxCommandEvent& event);
+    void OnInvalidStringFormat(wxCommandEvent& event);
+    void OnListLoadedModules(wxCommandEvent& event);
+    
+    // 'format string includes error'
+    wxString Êõ∏ÂºèÂ≠óÂàó„ÅÆË™§„Çä();
+
+private:
+    DECLARE_EVENT_TABLE()
+};
+
+// A trivial exception class
+class MyException
+{
+public:
+    MyException(const wxString& msg) : m_msg(msg) { }
+
+    const wxChar *what() const { return m_msg.c_str(); }
+
+private:
+    wxString m_msg;
+};
+
+// ----------------------------------------------------------------------------
+// constants
+// ----------------------------------------------------------------------------
+
+// IDs for the controls and the menu commands
+enum
+{
+    // control ids and menu items
+    Except_utf8_ShowAssert = wxID_HIGHEST,
+    Except_utf8_ListLoadedModules,
+    Except_utf8_ThrowObject,
+    Except_utf8_InvalidStringFormat,
+};
+
+// ----------------------------------------------------------------------------
+// event tables and other macros for wxWidgets
+// ----------------------------------------------------------------------------
+
+BEGIN_EVENT_TABLE(‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä, wxDialog)
+    EVT_BUTTON(Except_utf8_ShowAssert, ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä::OnShowAssert)
+    EVT_BUTTON(Except_utf8_ListLoadedModules, ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä::OnListLoadedModules)
+    EVT_BUTTON(Except_utf8_ThrowObject, ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä::OnThrowObject)
+    EVT_BUTTON(Except_utf8_InvalidStringFormat,
+               ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä::OnInvalidStringFormat)
+END_EVENT_TABLE()
+
+// ============================================================================
+// ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä implementation
+// ============================================================================
+
+‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä::‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä(wxFrame *parent)
+        : wxDialog(parent, wxID_ANY, wxString(wxT("Throw exception dialog")))
+{
+    wxSizer *sizerTop = new wxBoxSizer(wxVERTICAL);
+    
+    sizerTop->Add(new wxStaticText(this, wxNewId(),
+        wxT("Welcome. Now you can check whether your stack trace\ncorrectly ")
+        wxT("shows non-ASCII identifier used as class name.\n\n")
+        wxT("The name of this dialog class is '‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä'. ")),
+                  0, wxCENTRE | wxALL, 5);
+
+    sizerTop->Add(new wxButton(this, Except_utf8_ThrowObject, wxT("Throw &object")),
+                  0, wxCENTRE | wxALL, 5);
+    sizerTop->Add(new wxButton(this, Except_utf8_ShowAssert,
+                               wxT("Show &Assert invoked from wxArrayString")),
+                  0, wxCENTRE | wxALL, 5);
+    sizerTop->Add(new wxButton(this, Except_utf8_InvalidStringFormat,
+                               wxT("Call wxString::&Format with bad parameter")),
+                  0, wxCENTRE | wxALL, 5);
+    sizerTop->Add(new wxButton(this, Except_utf8_ListLoadedModules,
+                               wxT("List loaded modules")),
+                  0, wxCENTRE | wxALL, 5);
+    sizerTop->Add(new wxButton(this, wxID_CANCEL, wxT("&Cancel")),
+                  0, wxCENTRE | wxALL, 5);
+
+    SetSizerAndFit(sizerTop);
+}
+
+void ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä::OnThrowObject(wxCommandEvent& WXUNUSED(event))
+{
+    throw MyException(wxT("Exception thrown from ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä"));
+}
+
+void ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä::OnShowAssert(wxCommandEvent& WXUNUSED(event))
+{
+    // provoke an assert from wxArrayString.
+    // to test stack trace can include non-ASCII named class.
+    wxArrayString arr;
+    arr[0];
+}
+
+void ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä::OnListLoadedModules(wxCommandEvent& WXUNUSED(event))
+{
+    wxDynamicLibraryDetailsArray list = wxDynamicLibrary::ListLoaded();
+    wxString s;
+    for (size_t i=0; i<list.Count(); ++i)
+    {
+        s << list[i].GetName() << wxT(" ");
+        if (list[i].GetVersion().Trim().Trim(false).size())
+        {
+            s << list[i].GetVersion() << wxT("\n");
+        }
+        else
+        {
+            s << wxT("(not versioned)\n");
+        }
+    }
+    wxMessageBox(s, wxT("The modules currently loaded are:"));
+}
+
+
+wxString ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä::Êõ∏ÂºèÂ≠óÂàó„ÅÆË™§„Çä()
+{
+    // provoke an assert from wxString::Format.
+    // currently, assertion faied in wxArgNormalizer<int>::wxArgNormalizer<int>.
+    return wxString::Format("%s", 1717);
+}
+
+void ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä::OnInvalidStringFormat(wxCommandEvent& WXUNUSED(event))
+{
+    // to test stack trace can include non-ASCII named function.
+    Êõ∏ÂºèÂ≠óÂàó„ÅÆË™§„Çä();
+}
+
+// ============================================================================
+// global functions implementation
+// ============================================================================
+
+wxDialog* GenerateDialogUnicode(wxFrame* parent)
+{
+    return new ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢Êó•Êú¨Ë™û‡§π‡§ø‡§®‡•ç‡§¶‡•Ä(parent);
+}
+
+#endif // STACKTRACE_CAN_INCLUDE_UNICODE
+
Index: samples/except/except_utf8.h
===================================================================
--- samples/except/except_utf8.h	(ÉäÉrÉWÉáÉì 0)
+++ samples/except/except_utf8.h	(çÏã∆ÉRÉsÅ[)
@@ -0,0 +1,23 @@
+/////////////////////////////////////////////////////////////////////////////
+// Name:        samples/except/except_utf8.h
+// Purpose:     check stacktrace works correctly with non-ASCII identifiers
+// Author:      Suzumizaki-kimitaka
+// Modified by: 
+// Created:     2013-04-08
+// RCS-ID:      
+// Copyright:   (C) Suzumizaki-kimitaka
+// Licence:     wxWindows licence
+/////////////////////////////////////////////////////////////////////////////
+
+#ifndef STACKTRACE_CAN_INCLUDE_UNICODE
+#define STACKTRACE_CAN_INCLUDE_UNICODE 1
+#endif
+
+#if STACKTRACE_CAN_INCLUDE_UNICODE
+
+#include "wx/dialog.h"
+#include "wx/frame.h"
+wxDialog* GenerateDialogUnicode(wxFrame* parent);
+
+#endif
+
Index: samples/except/except_vc7.vcproj
===================================================================
--- samples/except/except_vc7.vcproj	(ÉäÉrÉWÉáÉì 73805)
+++ samples/except/except_vc7.vcproj	(çÏã∆ÉRÉsÅ[)
@@ -286,8 +286,19 @@
 			<File
 				RelativePath=".\except.cpp">
 			</File>
+			<File
+				RelativePath=".\except_utf8.cpp">
+			</File>
 		</Filter>
 		<Filter
+			Name="Header Files"
+			Filter="h;hpp;hxx;hm;inl;inc;xsd"
+			UniqueIdentifier="{93995380-89BD-4b04-88EB-625FBE52EBFB}">
+			<File
+				RelativePath=".\except_utf8.h">
+			</File>
+		</Filter>
+		<Filter
 			Name="Resource Files"
 			Filter="rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav"
 			UniqueIdentifier="{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}">
Index: samples/except/except_vc8.vcproj
===================================================================
--- samples/except/except_vc8.vcproj	(ÉäÉrÉWÉáÉì 73805)
+++ samples/except/except_vc8.vcproj	(çÏã∆ÉRÉsÅ[)
@@ -421,8 +421,22 @@
 				RelativePath=".\except.cpp"
 				>
 			</File>
+			<File
+				RelativePath=".\except_utf8.cpp"
+				>
+			</File>
 		</Filter>
 		<Filter
+			Name="Header Files"
+			Filter="h;hpp;hxx;hm;inl;inc;xsd"
+			UniqueIdentifier="{93995380-89BD-4b04-88EB-625FBE52EBFB}"
+			>
+			<File
+				RelativePath=".\except_utf8.h"
+				>
+			</File>
+		</Filter>
+		<Filter
 			Name="Resource Files"
 			Filter="rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav"
 			UniqueIdentifier="{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}"
Index: samples/except/except_vc9.vcproj
===================================================================
--- samples/except/except_vc9.vcproj	(ÉäÉrÉWÉáÉì 73805)
+++ samples/except/except_vc9.vcproj	(çÏã∆ÉRÉsÅ[)
@@ -407,8 +407,22 @@
 				RelativePath=".\except.cpp"
 				>
 			</File>
+			<File
+				RelativePath=".\except_utf8.cpp"
+				>
+			</File>
 		</Filter>
 		<Filter
+			Name="Header Files"
+			Filter="h;hpp;hxx;hm;inl;inc;xsd"
+			UniqueIdentifier="{93995380-89BD-4b04-88EB-625FBE52EBFB}"
+			>
+			<File
+				RelativePath=".\except_utf8.h"
+				>
+			</File>
+		</Filter>
+		<Filter
 			Name="Resource Files"
 			Filter="rc;ico;cur;bmp;dlg;rc2;rct;bin;rgs;gif;jpg;jpeg;jpe;resx;tiff;tif;png;wav"
 			UniqueIdentifier="{67DA6AB6-F800-4c08-8B7A-83BB121AAD01}"
Index: samples/except/makefile.bcc
===================================================================
--- samples/except/makefile.bcc	(ÉäÉrÉWÉáÉì 73805)
+++ samples/except/makefile.bcc	(çÏã∆ÉRÉsÅ[)
@@ -24,41 +24,42 @@
 WX_RELEASE_NODOT = 29
 COMPILER_PREFIX = bcc
 OBJS = \
-	$(COMPILER_PREFIX)$(COMPILER_VERSION)_$(PORTNAME)$(WXUNIVNAME)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WXDLLFLAG)$(CFG)
-LIBDIRNAME = \
-	.\..\..\lib\$(COMPILER_PREFIX)$(COMPILER_VERSION)_$(LIBTYPE_SUFFIX)$(CFG)
+	$(COMPILER_PREFIX)$(COMPILER_VERSION)_$(PORTNAME)$(WXUNIVNAME)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WXDLLFLAG)$(CFG)
+LIBDIRNAME = \
+	.\..\..\lib\$(COMPILER_PREFIX)$(COMPILER_VERSION)_$(LIBTYPE_SUFFIX)$(CFG)
 SETUPHDIR = \
 	$(LIBDIRNAME)\$(PORTNAME)$(WXUNIVNAME)$(WXUNICODEFLAG)$(WXDEBUGFLAG)
 EXCEPT_CXXFLAGS = $(__RUNTIME_LIBS_7) -I$(BCCDIR)\include $(__DEBUGINFO) \
-	$(__OPTIMIZEFLAG_2) $(__THREADSFLAG_6) -D__WX$(TOOLKIT)__ \
-	$(__WXUNIV_DEFINE_p) $(__DEBUG_DEFINE_p) $(__NDEBUG_DEFINE_p) \
-	$(__EXCEPTIONS_DEFINE_p) $(__RTTI_DEFINE_p) $(__THREAD_DEFINE_p) \
-	$(__UNICODE_DEFINE_p) $(__MSLU_DEFINE_p) -I$(SETUPHDIR) -I.\..\..\include \
+	$(__OPTIMIZEFLAG_2) $(__THREADSFLAG_6) -D__WX$(TOOLKIT)__ \
+	$(__WXUNIV_DEFINE_p) $(__DEBUG_DEFINE_p) $(__NDEBUG_DEFINE_p) \
+	$(__EXCEPTIONS_DEFINE_p) $(__RTTI_DEFINE_p) $(__THREAD_DEFINE_p) \
+	$(__UNICODE_DEFINE_p) $(__MSLU_DEFINE_p) -I$(SETUPHDIR) -I.\..\..\include \
 	$(____CAIRO_INCLUDEDIR_FILENAMES_p) -I. $(__DLLFLAG_p) -I.\..\..\samples \
 	-DNOPCH $(CPPFLAGS) $(CXXFLAGS)
 EXCEPT_OBJECTS =  \
-	$(OBJS)\except_except.obj
+	$(OBJS)\except_except.obj \
+	$(OBJS)\except_except_utf8.obj
 
 ### Conditionally set variables: ###
 
-!if "$(TOOLKIT)" == "GTK"
-WIN32_TOOLKIT_LOWERCASE = gtk
-!endif
-!if "$(TOOLKIT)" == "MSW"
-WIN32_TOOLKIT_LOWERCASE = msw
-!endif
+!if "$(TOOLKIT)" == "GTK"
+WIN32_TOOLKIT_LOWERCASE = gtk
+!endif
+!if "$(TOOLKIT)" == "MSW"
+WIN32_TOOLKIT_LOWERCASE = msw
+!endif
 !if "$(USE_GUI)" == "0"
 PORTNAME = base
 !endif
 !if "$(USE_GUI)" == "1"
-PORTNAME = $(WIN32_TOOLKIT_LOWERCASE)$(TOOLKIT_VERSION)
-!endif
-!if "$(TOOLKIT)" == "MAC"
-WXBASEPORT = _carbon
-!endif
-!if "$(OFFICIAL_BUILD)" == "1"
-COMPILER_VERSION = ERROR-COMPILER-VERSION-MUST-BE-SET-FOR-OFFICIAL-BUILD
+PORTNAME = $(WIN32_TOOLKIT_LOWERCASE)$(TOOLKIT_VERSION)
 !endif
+!if "$(TOOLKIT)" == "MAC"
+WXBASEPORT = _carbon
+!endif
+!if "$(OFFICIAL_BUILD)" == "1"
+COMPILER_VERSION = ERROR-COMPILER-VERSION-MUST-BE-SET-FOR-OFFICIAL-BUILD
+!endif
 !if "$(BUILD)" == "debug"
 WXDEBUGFLAG = d
 !endif
@@ -83,11 +84,11 @@
 !if "$(MONOLITHIC)" == "1"
 EXTRALIBS_FOR_BASE =   
 !endif
-!if "$(TOOLKIT)" == "GTK" && "$(TOOLKIT_VERSION)" == "2"
-LIB_GTK = gtk-win32-2.0.lib gdk-win32-2.0.lib pangocairo-1.0.lib \
-	gdk_pixbuf-2.0.lib cairo.lib pango-1.0.lib gobject-2.0.lib gthread-2.0.lib \
-	glib-2.0.lib
-!endif
+!if "$(TOOLKIT)" == "GTK" && "$(TOOLKIT_VERSION)" == "2"
+LIB_GTK = gtk-win32-2.0.lib gdk-win32-2.0.lib pangocairo-1.0.lib \
+	gdk_pixbuf-2.0.lib cairo.lib pango-1.0.lib gobject-2.0.lib gthread-2.0.lib \
+	glib-2.0.lib
+!endif
 !if "$(BUILD)" == "debug"
 __OPTIMIZEFLAG_2 = -Od
 !endif
@@ -190,7 +191,7 @@
 !endif
 !if "$(MONOLITHIC)" == "0"
 __WXLIB_BASE_p = \
-	wxbase$(WXBASEPORT)$(WX_RELEASE_NODOT)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WX_LIB_FLAVOUR).lib
+	wxbase$(WXBASEPORT)$(WX_RELEASE_NODOT)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WX_LIB_FLAVOUR).lib
 !endif
 !if "$(MONOLITHIC)" == "1"
 __WXLIB_MONO_p = \
@@ -249,12 +250,15 @@
 
 $(OBJS)\except.exe: $(EXCEPT_OBJECTS)  $(OBJS)\except_sample.res
 	ilink32 -Tpe -q  -L$(BCCDIR)\lib -L$(BCCDIR)\lib\psdk $(__DEBUGINFO)  -L$(LIBDIRNAME) -aa $(____CAIRO_LIBDIR_FILENAMES_p) $(LDFLAGS) @&&|
-	c0w32.obj $(EXCEPT_OBJECTS),$@,, $(__WXLIB_CORE_p)  $(__WXLIB_BASE_p)  $(__WXLIB_MONO_p) $(__LIB_TIFF_p) $(__LIB_JPEG_p) $(__LIB_PNG_p) $(LIB_GTK)  wxzlib$(WXDEBUGFLAG).lib wxregex$(WXUNICODEFLAG)$(WXDEBUGFLAG).lib wxexpat$(WXDEBUGFLAG).lib $(EXTRALIBS_FOR_BASE) $(__UNICOWS_LIB_p) $(__CAIRO_LIB_p) ole2w32.lib oleacc.lib import32.lib cw32$(__THREADSFLAG_5)$(__RUNTIME_LIBS_8).lib,, $(OBJS)\except_sample.res
+	c0w32.obj $(EXCEPT_OBJECTS),$@,, $(__WXLIB_CORE_p)  $(__WXLIB_BASE_p)  $(__WXLIB_MONO_p) $(__LIB_TIFF_p) $(__LIB_JPEG_p) $(__LIB_PNG_p) $(LIB_GTK)  wxzlib$(WXDEBUGFLAG).lib wxregex$(WXUNICODEFLAG)$(WXDEBUGFLAG).lib wxexpat$(WXDEBUGFLAG).lib $(EXTRALIBS_FOR_BASE) $(__UNICOWS_LIB_p) $(__CAIRO_LIB_p) ole2w32.lib oleacc.lib import32.lib cw32$(__THREADSFLAG_5)$(__RUNTIME_LIBS_8).lib,, $(OBJS)\except_sample.res
 |
 
 $(OBJS)\except_sample.res: .\..\..\samples\sample.rc
-	brcc32 -32 -r -fo$@ -i$(BCCDIR)\include    -d__WX$(TOOLKIT)__ $(__WXUNIV_DEFINE_p_1) $(__DEBUG_DEFINE_p_1) $(__NDEBUG_DEFINE_p_1) $(__EXCEPTIONS_DEFINE_p_1) $(__RTTI_DEFINE_p_1) $(__THREAD_DEFINE_p_1) $(__UNICODE_DEFINE_p_1) $(__MSLU_DEFINE_p_1) -i$(SETUPHDIR) -i.\..\..\include $(____CAIRO_INCLUDEDIR_FILENAMES_1_p) -i. $(__DLLFLAG_p_1) -i.\..\..\samples -dNOPCH .\..\..\samples\sample.rc
+	brcc32 -32 -r -fo$@ -i$(BCCDIR)\include    -d__WX$(TOOLKIT)__ $(__WXUNIV_DEFINE_p_1) $(__DEBUG_DEFINE_p_1) $(__NDEBUG_DEFINE_p_1) $(__EXCEPTIONS_DEFINE_p_1) $(__RTTI_DEFINE_p_1) $(__THREAD_DEFINE_p_1) $(__UNICODE_DEFINE_p_1) $(__MSLU_DEFINE_p_1) -i$(SETUPHDIR) -i.\..\..\include $(____CAIRO_INCLUDEDIR_FILENAMES_1_p) -i. $(__DLLFLAG_p_1) -i.\..\..\samples -dNOPCH .\..\..\samples\sample.rc
 
 $(OBJS)\except_except.obj: .\except.cpp
 	$(CXX) -q -c -P -o$@ $(EXCEPT_CXXFLAGS) .\except.cpp
 
+$(OBJS)\except_except_utf8.obj: .\except_utf8.cpp
+	$(CXX) -q -c -P -o$@ $(EXCEPT_CXXFLAGS) .\except_utf8.cpp
+
Index: samples/except/makefile.gcc
===================================================================
--- samples/except/makefile.gcc	(ÉäÉrÉWÉáÉì 73805)
+++ samples/except/makefile.gcc	(çÏã∆ÉRÉsÅ[)
@@ -16,31 +16,32 @@
 WX_RELEASE_NODOT = 29
 COMPILER_PREFIX = gcc
 OBJS = \
-	$(COMPILER_PREFIX)$(COMPILER_VERSION)_$(PORTNAME)$(WXUNIVNAME)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WXDLLFLAG)$(CFG)
-LIBDIRNAME = \
-	.\..\..\lib\$(COMPILER_PREFIX)$(COMPILER_VERSION)_$(LIBTYPE_SUFFIX)$(CFG)
+	$(COMPILER_PREFIX)$(COMPILER_VERSION)_$(PORTNAME)$(WXUNIVNAME)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WXDLLFLAG)$(CFG)
+LIBDIRNAME = \
+	.\..\..\lib\$(COMPILER_PREFIX)$(COMPILER_VERSION)_$(LIBTYPE_SUFFIX)$(CFG)
 SETUPHDIR = \
 	$(LIBDIRNAME)\$(PORTNAME)$(WXUNIVNAME)$(WXUNICODEFLAG)$(WXDEBUGFLAG)
 EXCEPT_CXXFLAGS = $(__DEBUGINFO) $(__OPTIMIZEFLAG_2) $(__THREADSFLAG) \
-	$(GCCFLAGS) -DHAVE_W32API_H -D__WX$(TOOLKIT)__ $(__WXUNIV_DEFINE_p) \
+	$(GCCFLAGS) -DHAVE_W32API_H -D__WX$(TOOLKIT)__ $(__WXUNIV_DEFINE_p) \
 	$(__DEBUG_DEFINE_p) $(__NDEBUG_DEFINE_p) $(__EXCEPTIONS_DEFINE_p) \
 	$(__RTTI_DEFINE_p) $(__THREAD_DEFINE_p) $(__UNICODE_DEFINE_p) \
 	$(__MSLU_DEFINE_p) -I$(SETUPHDIR) -I.\..\..\include \
 	$(____CAIRO_INCLUDEDIR_FILENAMES_p) -W -Wall -I. $(__DLLFLAG_p) \
 	-I.\..\..\samples -DNOPCH $(__RTTIFLAG_5) $(__EXCEPTIONSFLAG_6) \
-	-Wno-ctor-dtor-privacy $(CXXFLAGS_GTK_WINDOWS_GCC) $(CPPFLAGS) $(CXXFLAGS)
+	-Wno-ctor-dtor-privacy $(CXXFLAGS_GTK_WINDOWS_GCC) $(CPPFLAGS) $(CXXFLAGS)
 EXCEPT_OBJECTS =  \
 	$(OBJS)\except_sample_rc.o \
-	$(OBJS)\except_except.o
+	$(OBJS)\except_except.o \
+	$(OBJS)\except_except_utf8.o
 
 ### Conditionally set variables: ###
 
-ifeq ($(TOOLKIT),GTK)
-WIN32_TOOLKIT_LOWERCASE = gtk
-endif
-ifeq ($(TOOLKIT),MSW)
-WIN32_TOOLKIT_LOWERCASE = msw
-endif
+ifeq ($(TOOLKIT),GTK)
+WIN32_TOOLKIT_LOWERCASE = gtk
+endif
+ifeq ($(TOOLKIT),MSW)
+WIN32_TOOLKIT_LOWERCASE = msw
+endif
 ifeq ($(GCC_VERSION),2.95)
 GCCFLAGS = -fvtable-thunks
 endif
@@ -48,14 +49,14 @@
 PORTNAME = base
 endif
 ifeq ($(USE_GUI),1)
-PORTNAME = $(WIN32_TOOLKIT_LOWERCASE)$(TOOLKIT_VERSION)
-endif
-ifeq ($(TOOLKIT),MAC)
-WXBASEPORT = _carbon
-endif
-ifeq ($(OFFICIAL_BUILD),1)
-COMPILER_VERSION = ERROR-COMPILER-VERSION-MUST-BE-SET-FOR-OFFICIAL-BUILD
+PORTNAME = $(WIN32_TOOLKIT_LOWERCASE)$(TOOLKIT_VERSION)
 endif
+ifeq ($(TOOLKIT),MAC)
+WXBASEPORT = _carbon
+endif
+ifeq ($(OFFICIAL_BUILD),1)
+COMPILER_VERSION = ERROR-COMPILER-VERSION-MUST-BE-SET-FOR-OFFICIAL-BUILD
+endif
 ifeq ($(BUILD),debug)
 WXDEBUGFLAG = d
 endif
@@ -80,16 +81,16 @@
 ifeq ($(MONOLITHIC),1)
 EXTRALIBS_FOR_BASE =   
 endif
-ifeq ($(TOOLKIT),GTK)
-CXXFLAGS_GTK_WINDOWS_GCC = -mms-bitfields
-endif
-ifeq ($(TOOLKIT),GTK)
-ifeq ($(TOOLKIT_VERSION),2)
-LIB_GTK = gtk-win32-2.0.lib gdk-win32-2.0.lib pangocairo-1.0.lib \
-	gdk_pixbuf-2.0.lib cairo.lib pango-1.0.lib gobject-2.0.lib gthread-2.0.lib \
-	glib-2.0.lib
-endif
-endif
+ifeq ($(TOOLKIT),GTK)
+CXXFLAGS_GTK_WINDOWS_GCC = -mms-bitfields
+endif
+ifeq ($(TOOLKIT),GTK)
+ifeq ($(TOOLKIT_VERSION),2)
+LIB_GTK = gtk-win32-2.0.lib gdk-win32-2.0.lib pangocairo-1.0.lib \
+	gdk_pixbuf-2.0.lib cairo.lib pango-1.0.lib gobject-2.0.lib gthread-2.0.lib \
+	glib-2.0.lib
+endif
+endif
 ifeq ($(BUILD),debug)
 __OPTIMIZEFLAG_2 = -O0
 endif
@@ -180,7 +181,7 @@
 endif
 ifeq ($(MONOLITHIC),0)
 __WXLIB_BASE_p = \
-	-lwxbase$(WXBASEPORT)$(WX_RELEASE_NODOT)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WX_LIB_FLAVOUR)
+	-lwxbase$(WXBASEPORT)$(WX_RELEASE_NODOT)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WX_LIB_FLAVOUR)
 endif
 ifeq ($(MONOLITHIC),1)
 __WXLIB_MONO_p = \
@@ -242,14 +243,17 @@
 	-if exist $(OBJS)\except.exe del $(OBJS)\except.exe
 
 $(OBJS)\except.exe: $(EXCEPT_OBJECTS) $(OBJS)\except_sample_rc.o
-	$(CXX) -o $@ $(EXCEPT_OBJECTS)  $(__DEBUGINFO) $(__THREADSFLAG) -L$(LIBDIRNAME) -Wl,--subsystem,windows -mwindows $(____CAIRO_LIBDIR_FILENAMES_p) $(LDFLAGS)  $(__WXLIB_CORE_p)  $(__WXLIB_BASE_p)  $(__WXLIB_MONO_p) $(__LIB_TIFF_p) $(__LIB_JPEG_p) $(__LIB_PNG_p) $(LIB_GTK)  -lwxzlib$(WXDEBUGFLAG) -lwxregex$(WXUNICODEFLAG)$(WXDEBUGFLAG) -lwxexpat$(WXDEBUGFLAG) $(EXTRALIBS_FOR_BASE) $(__UNICOWS_LIB_p) $(__CAIRO_LIB_p) -lkernel32 -luser32 -lgdi32 -lcomdlg32 -lwinspool -lwinmm -lshell32 -lcomctl32 -lole32 -loleaut32 -luuid -lrpcrt4 -ladvapi32 -lwsock32 -lwininet
+	$(CXX) -o $@ $(EXCEPT_OBJECTS)  $(__DEBUGINFO) $(__THREADSFLAG) -L$(LIBDIRNAME) -Wl,--subsystem,windows -mwindows $(____CAIRO_LIBDIR_FILENAMES_p) $(LDFLAGS)  $(__WXLIB_CORE_p)  $(__WXLIB_BASE_p)  $(__WXLIB_MONO_p) $(__LIB_TIFF_p) $(__LIB_JPEG_p) $(__LIB_PNG_p) $(LIB_GTK)  -lwxzlib$(WXDEBUGFLAG) -lwxregex$(WXUNICODEFLAG)$(WXDEBUGFLAG) -lwxexpat$(WXDEBUGFLAG) $(EXTRALIBS_FOR_BASE) $(__UNICOWS_LIB_p) $(__CAIRO_LIB_p) -lkernel32 -luser32 -lgdi32 -lcomdlg32 -lwinspool -lwinmm -lshell32 -lcomctl32 -lole32 -loleaut32 -luuid -lrpcrt4 -ladvapi32 -lwsock32 -lwininet
 
 $(OBJS)\except_sample_rc.o: ./../../samples/sample.rc
-	windres --use-temp-file -i$< -o$@    --define __WX$(TOOLKIT)__ $(__WXUNIV_DEFINE_p_1) $(__DEBUG_DEFINE_p_1) $(__NDEBUG_DEFINE_p_1) $(__EXCEPTIONS_DEFINE_p_1) $(__RTTI_DEFINE_p_1) $(__THREAD_DEFINE_p_1) $(__UNICODE_DEFINE_p_1) $(__MSLU_DEFINE_p_1) --include-dir $(SETUPHDIR) --include-dir ./../../include $(__CAIRO_INCLUDEDIR_p) --include-dir . $(__DLLFLAG_p_1) --include-dir ./../../samples --define NOPCH
+	windres --use-temp-file -i$< -o$@    --define __WX$(TOOLKIT)__ $(__WXUNIV_DEFINE_p_1) $(__DEBUG_DEFINE_p_1) $(__NDEBUG_DEFINE_p_1) $(__EXCEPTIONS_DEFINE_p_1) $(__RTTI_DEFINE_p_1) $(__THREAD_DEFINE_p_1) $(__UNICODE_DEFINE_p_1) $(__MSLU_DEFINE_p_1) --include-dir $(SETUPHDIR) --include-dir ./../../include $(__CAIRO_INCLUDEDIR_p) --include-dir . $(__DLLFLAG_p_1) --include-dir ./../../samples --define NOPCH
 
 $(OBJS)\except_except.o: ./except.cpp
 	$(CXX) -c -o $@ $(EXCEPT_CXXFLAGS) $(CPPDEPS) $<
 
+$(OBJS)\except_except_utf8.o: ./except_utf8.cpp
+	$(CXX) -c -o $@ $(EXCEPT_CXXFLAGS) $(CPPDEPS) $<
+
 .PHONY: all clean
 
 
Index: samples/except/Makefile.in
===================================================================
--- samples/except/Makefile.in	(ÉäÉrÉWÉáÉì 73805)
+++ samples/except/Makefile.in	(çÏã∆ÉRÉsÅ[)
@@ -50,7 +50,8 @@
 EXCEPT_OBJECTS =  \
 	$(__except___win32rc) \
 	$(__except_os2_lib_res) \
-	except_except.o
+	except_except.o \
+	except_except_utf8.o
 
 ### Conditionally set variables: ###
 
@@ -182,7 +183,10 @@
 except_except.o: $(srcdir)/except.cpp
 	$(CXXC) -c -o $@ $(EXCEPT_CXXFLAGS) $(srcdir)/except.cpp
 
+except_except_utf8.o: $(srcdir)/except_utf8.cpp
+	$(CXXC) -c -o $@ $(EXCEPT_CXXFLAGS) $(srcdir)/except_utf8.cpp
 
+
 # Include dependency info, if present:
 @IF_GNU_MAKE@-include ./.deps/*.d
 
Index: samples/except/makefile.unx
===================================================================
--- samples/except/makefile.unx	(ÉäÉrÉWÉáÉì 73805)
+++ samples/except/makefile.unx	(çÏã∆ÉRÉsÅ[)
@@ -53,7 +53,8 @@
 EXCEPT_CXXFLAGS = -I. `$(WX_CONFIG) --cxxflags $(WX_CONFIG_FLAGS)` $(CPPFLAGS) \
 	$(CXXFLAGS)
 EXCEPT_OBJECTS =  \
-	except_except.o
+	except_except.o \
+	except_except_utf8.o
 
 ### Conditionally set variables: ###
 
@@ -93,6 +94,9 @@
 except_except.o: ./except.cpp
 	$(CXX) -c -o $@ $(EXCEPT_CXXFLAGS) $(CPPDEPS) $<
 
+except_except_utf8.o: ./except_utf8.cpp
+	$(CXX) -c -o $@ $(EXCEPT_CXXFLAGS) $(CPPDEPS) $<
+
 .PHONY: all install uninstall clean
 
 
Index: samples/except/makefile.vc
===================================================================
--- samples/except/makefile.vc	(ÉäÉrÉWÉáÉì 73805)
+++ samples/except/makefile.vc	(çÏã∆ÉRÉsÅ[)
@@ -15,65 +15,66 @@
 WX_RELEASE_NODOT = 29
 COMPILER_PREFIX = vc
 OBJS = \
-	$(COMPILER_PREFIX)$(COMPILER_VERSION)_$(PORTNAME)$(WXUNIVNAME)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WXDLLFLAG)$(CFG)$(ARCH_SUFFIX)
+	$(COMPILER_PREFIX)$(COMPILER_VERSION)_$(PORTNAME)$(WXUNIVNAME)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WXDLLFLAG)$(CFG)$(ARCH_SUFFIX)
 LIBDIRNAME = \
-	.\..\..\lib\$(COMPILER_PREFIX)$(COMPILER_VERSION)$(ARCH_SUFFIX)_$(LIBTYPE_SUFFIX)$(CFG)
+	.\..\..\lib\$(COMPILER_PREFIX)$(COMPILER_VERSION)$(ARCH_SUFFIX)_$(LIBTYPE_SUFFIX)$(CFG)
 SETUPHDIR = \
 	$(LIBDIRNAME)\$(PORTNAME)$(WXUNIVNAME)$(WXUNICODEFLAG)$(WXDEBUGFLAG)
 EXCEPT_CXXFLAGS = /M$(__RUNTIME_LIBS_10)$(__DEBUGRUNTIME_4) /DWIN32 \
 	$(__DEBUGINFO_0) /Fd$(OBJS)\except.pdb $(____DEBUGRUNTIME_3_p) \
 	$(__OPTIMIZEFLAG_6) /D_CRT_SECURE_NO_DEPRECATE=1 \
 	/D_CRT_NON_CONFORMING_SWPRINTFS=1 /D_SCL_SECURE_NO_WARNINGS=1 \
-	$(__NO_VC_CRTDBG_p) /D__WX$(TOOLKIT)__ $(__WXUNIV_DEFINE_p) \
-	$(__DEBUG_DEFINE_p) $(__NDEBUG_DEFINE_p) $(__EXCEPTIONS_DEFINE_p) \
-	$(__RTTI_DEFINE_p) $(__THREAD_DEFINE_p) $(__UNICODE_DEFINE_p) \
-	$(__MSLU_DEFINE_p) /I$(SETUPHDIR) /I.\..\..\include \
-	$(____CAIRO_INCLUDEDIR_FILENAMES_p) /W4 /I. $(__DLLFLAG_p) /D_WINDOWS \
-	/I.\..\..\samples /DNOPCH $(__RTTIFLAG_11) $(__EXCEPTIONSFLAG_12) \
-	$(CPPFLAGS) $(CXXFLAGS)
+	$(__NO_VC_CRTDBG_p) /D__WX$(TOOLKIT)__ $(__WXUNIV_DEFINE_p) \
+	$(__DEBUG_DEFINE_p) $(__NDEBUG_DEFINE_p) $(__EXCEPTIONS_DEFINE_p) \
+	$(__RTTI_DEFINE_p) $(__THREAD_DEFINE_p) $(__UNICODE_DEFINE_p) \
+	$(__MSLU_DEFINE_p) /I$(SETUPHDIR) /I.\..\..\include \
+	$(____CAIRO_INCLUDEDIR_FILENAMES_p) /W4 /I. $(__DLLFLAG_p) /D_WINDOWS \
+	/I.\..\..\samples /DNOPCH $(__RTTIFLAG_11) $(__EXCEPTIONSFLAG_12) \
+	$(CPPFLAGS) $(CXXFLAGS)
 EXCEPT_OBJECTS =  \
-	$(OBJS)\except_except.obj
+	$(OBJS)\except_except.obj \
+	$(OBJS)\except_except_utf8.obj
 EXCEPT_RESOURCES =  \
 	$(OBJS)\except_sample.res
 
 ### Conditionally set variables: ###
 
-!if "$(TOOLKIT)" == "GTK"
-WIN32_TOOLKIT_LOWERCASE = gtk
-!endif
-!if "$(TOOLKIT)" == "MSW"
-WIN32_TOOLKIT_LOWERCASE = msw
-!endif
-!if "$(TARGET_CPU)" == "AMD64"
-ARCH_SUFFIX = _x64
-!endif
-!if "$(TARGET_CPU)" == "IA64"
-ARCH_SUFFIX = _ia64
-!endif
-!if "$(TARGET_CPU)" == "X64"
-ARCH_SUFFIX = _x64
-!endif
-!if "$(TARGET_CPU)" == "amd64"
-ARCH_SUFFIX = _x64
-!endif
-!if "$(TARGET_CPU)" == "ia64"
-ARCH_SUFFIX = _ia64
-!endif
-!if "$(TARGET_CPU)" == "x64"
-ARCH_SUFFIX = _x64
-!endif
+!if "$(TOOLKIT)" == "GTK"
+WIN32_TOOLKIT_LOWERCASE = gtk
+!endif
+!if "$(TOOLKIT)" == "MSW"
+WIN32_TOOLKIT_LOWERCASE = msw
+!endif
+!if "$(TARGET_CPU)" == "AMD64"
+ARCH_SUFFIX = _x64
+!endif
+!if "$(TARGET_CPU)" == "IA64"
+ARCH_SUFFIX = _ia64
+!endif
+!if "$(TARGET_CPU)" == "X64"
+ARCH_SUFFIX = _x64
+!endif
+!if "$(TARGET_CPU)" == "amd64"
+ARCH_SUFFIX = _x64
+!endif
+!if "$(TARGET_CPU)" == "ia64"
+ARCH_SUFFIX = _ia64
+!endif
+!if "$(TARGET_CPU)" == "x64"
+ARCH_SUFFIX = _x64
+!endif
 !if "$(USE_GUI)" == "0"
 PORTNAME = base
 !endif
 !if "$(USE_GUI)" == "1"
-PORTNAME = $(WIN32_TOOLKIT_LOWERCASE)$(TOOLKIT_VERSION)
-!endif
-!if "$(TOOLKIT)" == "MAC"
-WXBASEPORT = _carbon
-!endif
-!if "$(OFFICIAL_BUILD)" == "1"
-COMPILER_VERSION = ERROR-COMPILER-VERSION-MUST-BE-SET-FOR-OFFICIAL-BUILD
+PORTNAME = $(WIN32_TOOLKIT_LOWERCASE)$(TOOLKIT_VERSION)
 !endif
+!if "$(TOOLKIT)" == "MAC"
+WXBASEPORT = _carbon
+!endif
+!if "$(OFFICIAL_BUILD)" == "1"
+COMPILER_VERSION = ERROR-COMPILER-VERSION-MUST-BE-SET-FOR-OFFICIAL-BUILD
+!endif
 !if "$(BUILD)" == "debug" && "$(DEBUG_RUNTIME_LIBS)" == "default"
 WXDEBUGFLAG = d
 !endif
@@ -101,29 +102,29 @@
 !if "$(TARGET_CPU)" == "IA64"
 LINK_TARGET_CPU = /MACHINE:IA64
 !endif
-!if "$(TARGET_CPU)" == "X64"
-LINK_TARGET_CPU = /MACHINE:X64
-!endif
+!if "$(TARGET_CPU)" == "X64"
+LINK_TARGET_CPU = /MACHINE:X64
+!endif
 !if "$(TARGET_CPU)" == "amd64"
 LINK_TARGET_CPU = /MACHINE:X64
 !endif
 !if "$(TARGET_CPU)" == "ia64"
 LINK_TARGET_CPU = /MACHINE:IA64
 !endif
-!if "$(TARGET_CPU)" == "x64"
-LINK_TARGET_CPU = /MACHINE:X64
-!endif
+!if "$(TARGET_CPU)" == "x64"
+LINK_TARGET_CPU = /MACHINE:X64
+!endif
 !if "$(MONOLITHIC)" == "0"
 EXTRALIBS_FOR_BASE = 
 !endif
 !if "$(MONOLITHIC)" == "1"
 EXTRALIBS_FOR_BASE =   
 !endif
-!if "$(TOOLKIT)" == "GTK" && "$(TOOLKIT_VERSION)" == "2"
-LIB_GTK = gtk-win32-2.0.lib gdk-win32-2.0.lib pangocairo-1.0.lib \
-	gdk_pixbuf-2.0.lib cairo.lib pango-1.0.lib gobject-2.0.lib gthread-2.0.lib \
-	glib-2.0.lib
-!endif
+!if "$(TOOLKIT)" == "GTK" && "$(TOOLKIT_VERSION)" == "2"
+LIB_GTK = gtk-win32-2.0.lib gdk-win32-2.0.lib pangocairo-1.0.lib \
+	gdk_pixbuf-2.0.lib cairo.lib pango-1.0.lib gobject-2.0.lib gthread-2.0.lib \
+	glib-2.0.lib
+!endif
 !if "$(BUILD)" == "debug" && "$(DEBUG_INFO)" == "default"
 __DEBUGINFO_0 = /Zi
 !endif
@@ -328,7 +329,7 @@
 !endif
 !if "$(MONOLITHIC)" == "0"
 __WXLIB_BASE_p = \
-	wxbase$(WXBASEPORT)$(WX_RELEASE_NODOT)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WX_LIB_FLAVOUR).lib
+	wxbase$(WXBASEPORT)$(WX_RELEASE_NODOT)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WX_LIB_FLAVOUR).lib
 !endif
 !if "$(MONOLITHIC)" == "1"
 __WXLIB_MONO_p = \
@@ -372,12 +373,15 @@
 
 $(OBJS)\except.exe: $(EXCEPT_OBJECTS) $(OBJS)\except_sample.res
 	link /NOLOGO /OUT:$@  $(__DEBUGINFO_1) /pdb:"$(OBJS)\except.pdb" $(__DEBUGINFO_2)  $(LINK_TARGET_CPU) /LIBPATH:$(LIBDIRNAME) /SUBSYSTEM:WINDOWS $(____CAIRO_LIBDIR_FILENAMES_p) $(LDFLAGS) @<<
-	$(EXCEPT_OBJECTS) $(EXCEPT_RESOURCES)  $(__WXLIB_CORE_p)  $(__WXLIB_BASE_p)  $(__WXLIB_MONO_p) $(__LIB_TIFF_p) $(__LIB_JPEG_p) $(__LIB_PNG_p) $(LIB_GTK)  wxzlib$(WXDEBUGFLAG).lib wxregex$(WXUNICODEFLAG)$(WXDEBUGFLAG).lib wxexpat$(WXDEBUGFLAG).lib $(EXTRALIBS_FOR_BASE) $(__UNICOWS_LIB_p) $(__CAIRO_LIB_p) kernel32.lib user32.lib gdi32.lib comdlg32.lib winspool.lib winmm.lib shell32.lib comctl32.lib ole32.lib oleaut32.lib uuid.lib rpcrt4.lib advapi32.lib wsock32.lib wininet.lib
+	$(EXCEPT_OBJECTS) $(EXCEPT_RESOURCES)  $(__WXLIB_CORE_p)  $(__WXLIB_BASE_p)  $(__WXLIB_MONO_p) $(__LIB_TIFF_p) $(__LIB_JPEG_p) $(__LIB_PNG_p) $(LIB_GTK)  wxzlib$(WXDEBUGFLAG).lib wxregex$(WXUNICODEFLAG)$(WXDEBUGFLAG).lib wxexpat$(WXDEBUGFLAG).lib $(EXTRALIBS_FOR_BASE) $(__UNICOWS_LIB_p) $(__CAIRO_LIB_p) kernel32.lib user32.lib gdi32.lib comdlg32.lib winspool.lib winmm.lib shell32.lib comctl32.lib ole32.lib oleaut32.lib uuid.lib rpcrt4.lib advapi32.lib wsock32.lib wininet.lib
 <<
 
 $(OBJS)\except_sample.res: .\..\..\samples\sample.rc
-	rc /fo$@  /d WIN32 $(____DEBUGRUNTIME_3_p_1) /d _CRT_SECURE_NO_DEPRECATE=1 /d _CRT_NON_CONFORMING_SWPRINTFS=1 /d _SCL_SECURE_NO_WARNINGS=1 $(__NO_VC_CRTDBG_p_1)  /d __WX$(TOOLKIT)__ $(__WXUNIV_DEFINE_p_1) $(__DEBUG_DEFINE_p_1) $(__NDEBUG_DEFINE_p_1) $(__EXCEPTIONS_DEFINE_p_1) $(__RTTI_DEFINE_p_1) $(__THREAD_DEFINE_p_1) $(__UNICODE_DEFINE_p_1) $(__MSLU_DEFINE_p_1) /i $(SETUPHDIR) /i .\..\..\include $(____CAIRO_INCLUDEDIR_FILENAMES_1_p) /i . $(__DLLFLAG_p_1) /d _WINDOWS /i .\..\..\samples /d NOPCH .\..\..\samples\sample.rc
+	rc /fo$@  /d WIN32 $(____DEBUGRUNTIME_3_p_1) /d _CRT_SECURE_NO_DEPRECATE=1 /d _CRT_NON_CONFORMING_SWPRINTFS=1 /d _SCL_SECURE_NO_WARNINGS=1 $(__NO_VC_CRTDBG_p_1)  /d __WX$(TOOLKIT)__ $(__WXUNIV_DEFINE_p_1) $(__DEBUG_DEFINE_p_1) $(__NDEBUG_DEFINE_p_1) $(__EXCEPTIONS_DEFINE_p_1) $(__RTTI_DEFINE_p_1) $(__THREAD_DEFINE_p_1) $(__UNICODE_DEFINE_p_1) $(__MSLU_DEFINE_p_1) /i $(SETUPHDIR) /i .\..\..\include $(____CAIRO_INCLUDEDIR_FILENAMES_1_p) /i . $(__DLLFLAG_p_1) /d _WINDOWS /i .\..\..\samples /d NOPCH .\..\..\samples\sample.rc
 
 $(OBJS)\except_except.obj: .\except.cpp
 	$(CXX) /c /nologo /TP /Fo$@ $(EXCEPT_CXXFLAGS) .\except.cpp
 
+$(OBJS)\except_except_utf8.obj: .\except_utf8.cpp
+	$(CXX) /c /nologo /TP /Fo$@ $(EXCEPT_CXXFLAGS) .\except_utf8.cpp
+
Index: samples/except/makefile.wat
===================================================================
--- samples/except/makefile.wat	(ÉäÉrÉWÉáÉì 73805)
+++ samples/except/makefile.wat	(çÏã∆ÉRÉsÅ[)
@@ -31,28 +31,28 @@
 
 ### Conditionally set variables: ###
 
-WIN32_TOOLKIT_LOWERCASE =
-!ifeq TOOLKIT GTK
-WIN32_TOOLKIT_LOWERCASE = gtk
-!endif
-!ifeq TOOLKIT MSW
-WIN32_TOOLKIT_LOWERCASE = msw
-!endif
+WIN32_TOOLKIT_LOWERCASE =
+!ifeq TOOLKIT GTK
+WIN32_TOOLKIT_LOWERCASE = gtk
+!endif
+!ifeq TOOLKIT MSW
+WIN32_TOOLKIT_LOWERCASE = msw
+!endif
 PORTNAME =
 !ifeq USE_GUI 0
 PORTNAME = base
 !endif
 !ifeq USE_GUI 1
-PORTNAME = $(WIN32_TOOLKIT_LOWERCASE)$(TOOLKIT_VERSION)
-!endif
-WXBASEPORT =
-!ifeq TOOLKIT MAC
-WXBASEPORT = _carbon
-!endif
-COMPILER_VERSION =
-!ifeq OFFICIAL_BUILD 1
-COMPILER_VERSION = ERROR-COMPILER-VERSION-MUST-BE-SET-FOR-OFFICIAL-BUILD
+PORTNAME = $(WIN32_TOOLKIT_LOWERCASE)$(TOOLKIT_VERSION)
 !endif
+WXBASEPORT =
+!ifeq TOOLKIT MAC
+WXBASEPORT = _carbon
+!endif
+COMPILER_VERSION =
+!ifeq OFFICIAL_BUILD 1
+COMPILER_VERSION = ERROR-COMPILER-VERSION-MUST-BE-SET-FOR-OFFICIAL-BUILD
+!endif
 WXDEBUGFLAG =
 !ifeq BUILD debug
 WXDEBUGFLAG = d
@@ -83,14 +83,14 @@
 !ifeq MONOLITHIC 1
 EXTRALIBS_FOR_BASE =   
 !endif
-LIB_GTK =
-!ifeq TOOLKIT GTK
-!ifeq TOOLKIT_VERSION 2
-LIB_GTK = gtk-win32-2.0.lib gdk-win32-2.0.lib pangocairo-1.0.lib &
-	gdk_pixbuf-2.0.lib cairo.lib pango-1.0.lib gobject-2.0.lib gthread-2.0.lib &
-	glib-2.0.lib
-!endif
-!endif
+LIB_GTK =
+!ifeq TOOLKIT GTK
+!ifeq TOOLKIT_VERSION 2
+LIB_GTK = gtk-win32-2.0.lib gdk-win32-2.0.lib pangocairo-1.0.lib &
+	gdk_pixbuf-2.0.lib cairo.lib pango-1.0.lib gobject-2.0.lib gthread-2.0.lib &
+	glib-2.0.lib
+!endif
+!endif
 __DEBUGINFO_0 =
 !ifeq BUILD debug
 !ifeq DEBUG_INFO default
@@ -168,7 +168,7 @@
 __WXLIB_BASE_p =
 !ifeq MONOLITHIC 0
 __WXLIB_BASE_p = &
-	wxbase$(WXBASEPORT)$(WX_RELEASE_NODOT)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WX_LIB_FLAVOUR).lib
+	wxbase$(WXBASEPORT)$(WX_RELEASE_NODOT)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WX_LIB_FLAVOUR).lib
 !endif
 __WXLIB_MONO_p =
 !ifeq MONOLITHIC 1
@@ -240,20 +240,21 @@
 WX_RELEASE_NODOT = 29
 COMPILER_PREFIX = wat
 OBJS = &
-	$(COMPILER_PREFIX)$(COMPILER_VERSION)_$(PORTNAME)$(WXUNIVNAME)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WXDLLFLAG)$(CFG)
-LIBDIRNAME = &
-	.\..\..\lib\$(COMPILER_PREFIX)$(COMPILER_VERSION)_$(LIBTYPE_SUFFIX)$(CFG)
+	$(COMPILER_PREFIX)$(COMPILER_VERSION)_$(PORTNAME)$(WXUNIVNAME)$(WXUNICODEFLAG)$(WXDEBUGFLAG)$(WXDLLFLAG)$(CFG)
+LIBDIRNAME = &
+	.\..\..\lib\$(COMPILER_PREFIX)$(COMPILER_VERSION)_$(LIBTYPE_SUFFIX)$(CFG)
 SETUPHDIR = &
 	$(LIBDIRNAME)\$(PORTNAME)$(WXUNIVNAME)$(WXUNICODEFLAG)$(WXDEBUGFLAG)
 EXCEPT_CXXFLAGS = $(__DEBUGINFO_0) $(__OPTIMIZEFLAG_2) $(__THREADSFLAG_5) &
-	$(__RUNTIME_LIBS_6) -d__WX$(TOOLKIT)__ $(__WXUNIV_DEFINE_p) &
-	$(__DEBUG_DEFINE_p) $(__NDEBUG_DEFINE_p) $(__EXCEPTIONS_DEFINE_p) &
-	$(__RTTI_DEFINE_p) $(__THREAD_DEFINE_p) $(__UNICODE_DEFINE_p) &
-	-i=$(SETUPHDIR) -i=.\..\..\include $(____CAIRO_INCLUDEDIR_FILENAMES) -wx &
-	-wcd=549 -wcd=656 -wcd=657 -wcd=667 -i=. $(__DLLFLAG_p) -i=.\..\..\samples &
-	-dNOPCH $(__RTTIFLAG_7) $(__EXCEPTIONSFLAG_8) $(CPPFLAGS) $(CXXFLAGS)
+	$(__RUNTIME_LIBS_6) -d__WX$(TOOLKIT)__ $(__WXUNIV_DEFINE_p) &
+	$(__DEBUG_DEFINE_p) $(__NDEBUG_DEFINE_p) $(__EXCEPTIONS_DEFINE_p) &
+	$(__RTTI_DEFINE_p) $(__THREAD_DEFINE_p) $(__UNICODE_DEFINE_p) &
+	-i=$(SETUPHDIR) -i=.\..\..\include $(____CAIRO_INCLUDEDIR_FILENAMES) -wx &
+	-wcd=549 -wcd=656 -wcd=657 -wcd=667 -i=. $(__DLLFLAG_p) -i=.\..\..\samples &
+	-dNOPCH $(__RTTIFLAG_7) $(__EXCEPTIONSFLAG_8) $(CPPFLAGS) $(CXXFLAGS)
 EXCEPT_OBJECTS =  &
-	$(OBJS)\except_except.obj
+	$(OBJS)\except_except.obj &
+	$(OBJS)\except_except_utf8.obj
 
 
 all : $(OBJS)
@@ -279,14 +280,17 @@
 	@%append $(OBJS)\except.lbc option caseexact
 	@%append $(OBJS)\except.lbc  $(__DEBUGINFO_1)  libpath $(LIBDIRNAME) system nt_win ref '_WinMain@16' $(____CAIRO_LIBDIR_FILENAMES_p) $(LDFLAGS)
 	@for %i in ($(EXCEPT_OBJECTS)) do @%append $(OBJS)\except.lbc file %i
-	@for %i in ( $(__WXLIB_CORE_p)  $(__WXLIB_BASE_p)  $(__WXLIB_MONO_p) $(__LIB_TIFF_p) $(__LIB_JPEG_p) $(__LIB_PNG_p) $(LIB_GTK)  wxzlib$(WXDEBUGFLAG).lib wxregex$(WXUNICODEFLAG)$(WXDEBUGFLAG).lib wxexpat$(WXDEBUGFLAG).lib $(EXTRALIBS_FOR_BASE)  $(__CAIRO_LIB_p) kernel32.lib user32.lib gdi32.lib comdlg32.lib winspool.lib winmm.lib shell32.lib comctl32.lib ole32.lib oleaut32.lib uuid.lib rpcrt4.lib advapi32.lib wsock32.lib wininet.lib) do @%append $(OBJS)\except.lbc library %i
+	@for %i in ( $(__WXLIB_CORE_p)  $(__WXLIB_BASE_p)  $(__WXLIB_MONO_p) $(__LIB_TIFF_p) $(__LIB_JPEG_p) $(__LIB_PNG_p) $(LIB_GTK)  wxzlib$(WXDEBUGFLAG).lib wxregex$(WXUNICODEFLAG)$(WXDEBUGFLAG).lib wxexpat$(WXDEBUGFLAG).lib $(EXTRALIBS_FOR_BASE)  $(__CAIRO_LIB_p) kernel32.lib user32.lib gdi32.lib comdlg32.lib winspool.lib winmm.lib shell32.lib comctl32.lib ole32.lib oleaut32.lib uuid.lib rpcrt4.lib advapi32.lib wsock32.lib wininet.lib) do @%append $(OBJS)\except.lbc library %i
 	@%append $(OBJS)\except.lbc option resource=$(OBJS)\except_sample.res
 	@for %i in () do @%append $(OBJS)\except.lbc option stack=%i
 	wlink @$(OBJS)\except.lbc
 
 $(OBJS)\except_sample.res :  .AUTODEPEND .\..\..\samples\sample.rc
-	wrc -q -ad -bt=nt -r -fo=$^@    -d__WX$(TOOLKIT)__ $(__WXUNIV_DEFINE_p) $(__DEBUG_DEFINE_p) $(__NDEBUG_DEFINE_p) $(__EXCEPTIONS_DEFINE_p) $(__RTTI_DEFINE_p) $(__THREAD_DEFINE_p) $(__UNICODE_DEFINE_p)  -i=$(SETUPHDIR) -i=.\..\..\include $(____CAIRO_INCLUDEDIR_FILENAMES) -i=. $(__DLLFLAG_p) -i=.\..\..\samples -dNOPCH $<
+	wrc -q -ad -bt=nt -r -fo=$^@    -d__WX$(TOOLKIT)__ $(__WXUNIV_DEFINE_p) $(__DEBUG_DEFINE_p) $(__NDEBUG_DEFINE_p) $(__EXCEPTIONS_DEFINE_p) $(__RTTI_DEFINE_p) $(__THREAD_DEFINE_p) $(__UNICODE_DEFINE_p)  -i=$(SETUPHDIR) -i=.\..\..\include $(____CAIRO_INCLUDEDIR_FILENAMES) -i=. $(__DLLFLAG_p) -i=.\..\..\samples -dNOPCH $<
 
 $(OBJS)\except_except.obj :  .AUTODEPEND .\except.cpp
 	$(CXX) -bt=nt -zq -fo=$^@ $(EXCEPT_CXXFLAGS) $<
 
+$(OBJS)\except_except_utf8.obj :  .AUTODEPEND .\except_utf8.cpp
+	$(CXX) -bt=nt -zq -fo=$^@ $(EXCEPT_CXXFLAGS) $<
+
Index: src/msw/debughlp.cpp
===================================================================
--- src/msw/debughlp.cpp	(ÉäÉrÉWÉáÉì 73805)
+++ src/msw/debughlp.cpp	(çÏã∆ÉRÉsÅ[)
@@ -2,7 +2,7 @@
 // Name:        src/msw/debughlp.cpp
 // Purpose:     various Win32 debug helpers
 // Author:      Vadim Zeitlin
-// Modified by:
+// Modified by: Suzumizaki-kimitaka 2013-04-10
 // Created:     2005-01-08 (extracted from crashrpt.cpp)
 // RCS-ID:      $Id$
 // Copyright:   (c) 2003-2005 Vadim Zeitlin <vadim@wxwindows.org>
@@ -63,7 +63,8 @@
 
 // load all function we need from the DLL
 
-static bool BindDbgHelpFunctions(const wxDynamicLibrary& dllDbgHelp)
+/* static */
+bool wxDbgHelpDLL::BindDbgHelpFunctions(const wxDynamicLibrary& dllDbgHelp)
 {
     #define LOAD_SYM_FUNCTION(func, name)                                     \
         wxDbgHelpDLL::func = (wxDbgHelpDLL::func ## _t)                       \
@@ -74,15 +75,27 @@
             return false;                                                     \
         }
 
-    wxDO_FOR_ALL_SYM_FUNCS(LOAD_SYM_FUNCTION);
+    wxDO_FOR_ALL_SYM_FUNCS_REQUIRED(LOAD_SYM_FUNCTION);
 
     #undef LOAD_SYM_FUNCTION
 
+    #define LOAD_SYM_FUNCTION_OPTIONAL(func, name)                            \
+        if ( dllDbgHelp.HasSymbol(wxT(#name)) )                               \
+        {                                                                     \
+            wxDbgHelpDLL::func = (wxDbgHelpDLL::func ## _t)                   \
+                dllDbgHelp.GetSymbol(wxT(#name));                             \
+        }
+    
+    wxDO_FOR_ALL_SYM_FUNCS_OPTIONAL(LOAD_SYM_FUNCTION_OPTIONAL);
+
+    #undef LOAD_SYM_FUNCTION_CAN_FAIL
+
     return true;
 }
 
 // called by Init() if we hadn't done this before
-static bool DoInit()
+/* static */
+bool wxDbgHelpDLL::DoInit()
 {
     wxDynamicLibrary dllDbgHelp(wxT("dbghelp.dll"), wxDL_VERBATIM);
     if ( dllDbgHelp.IsLoaded() )
@@ -171,13 +184,13 @@
 
 static inline
 bool
-DoGetTypeInfo(PSYMBOL_INFO pSym, IMAGEHLP_SYMBOL_TYPE_INFO type, void *rc)
+DoGetTypeInfo(wxPSYMBOL_INFO pSym, IMAGEHLP_SYMBOL_TYPE_INFO type, void *rc)
 {
     return DoGetTypeInfo(pSym->ModBase, pSym->TypeIndex, type, rc);
 }
 
 static inline
-wxDbgHelpDLL::BasicType GetBasicType(PSYMBOL_INFO pSym)
+wxDbgHelpDLL::BasicType GetBasicType(wxPSYMBOL_INFO pSym)
 {
     wxDbgHelpDLL::BasicType bt;
     return DoGetTypeInfo(pSym, TI_GET_BASETYPE, &bt)
@@ -186,7 +199,7 @@
 }
 
 /* static */
-wxString wxDbgHelpDLL::GetSymbolName(PSYMBOL_INFO pSym)
+wxString wxDbgHelpDLL::GetSymbolName(wxPSYMBOL_INFO pSym)
 {
     wxString s;
 
@@ -290,7 +303,7 @@
 }
 
 wxString
-wxDbgHelpDLL::DumpField(PSYMBOL_INFO pSym, void *pVariable, unsigned level)
+wxDbgHelpDLL::DumpField(wxPSYMBOL_INFO pSym, void *pVariable, unsigned level)
 {
     wxString s;
 
@@ -337,7 +350,7 @@
 
 
                 // now pass to the type representing the type of this member
-                SYMBOL_INFO sym = *pSym;
+                wxSYMBOL_INFO sym = *pSym;
                 if ( !DoGetTypeInfo(pSym, TI_GET_TYPEID, &sym.TypeIndex) )
                     break;
 
@@ -388,7 +401,7 @@
 }
 
 /* static */ wxString
-wxDbgHelpDLL::DumpUDT(PSYMBOL_INFO pSym, void *pVariable, unsigned level)
+wxDbgHelpDLL::DumpUDT(wxPSYMBOL_INFO pSym, void *pVariable, unsigned level)
 {
     wxString s;
 
@@ -455,7 +468,7 @@
         s << wxT(" {\n");
 
         // Iterate through all children
-        SYMBOL_INFO sym;
+        wxSYMBOL_INFO sym;
         wxZeroMemory(sym);
         sym.ModBase = pSym->ModBase;
         for ( unsigned i = 0; i < dwChildrenCount; i++ )
@@ -487,7 +500,7 @@
 
 /* static */
 wxDbgHelpDLL::SymbolTag
-wxDbgHelpDLL::DereferenceSymbol(PSYMBOL_INFO pSym, void **ppData)
+wxDbgHelpDLL::DereferenceSymbol(wxPSYMBOL_INFO pSym, void **ppData)
 {
     SymbolTag tag = SYMBOL_TAG_NULL;
     for ( ;; )
@@ -524,10 +537,10 @@
 }
 
 /* static */ wxString
-wxDbgHelpDLL::DumpSymbol(PSYMBOL_INFO pSym, void *pVariable)
+wxDbgHelpDLL::DumpSymbol(wxPSYMBOL_INFO pSym, void *pVariable)
 {
     wxString s;
-    SYMBOL_INFO symDeref = *pSym;
+    wxSYMBOL_INFO symDeref = *pSym;
     switch ( DereferenceSymbol(&symDeref, &pVariable) )
     {
         default:
@@ -554,6 +567,330 @@
 }
 
 // ----------------------------------------------------------------------------
+// do the best functions and structures
+// ----------------------------------------------------------------------------
+
+struct wxMswEnmLddMdlsHelperStruct
+{
+public:
+    wxMswEnmLddMdlsHelperStruct(wxPENUMLOADED_MODULES_CALLBACK64 ptr, PVOID content)
+        : m_pointer_to_callback(ptr), m_user_content(content)
+    { }
+    wxPENUMLOADED_MODULES_CALLBACK64 m_pointer_to_callback;
+    PVOID m_user_content;
+};
+
+#ifdef UNICODE
+
+static BOOL CALLBACK wxMswEnmLddMdlsCallback1(
+    PCSTR ModuleName, DWORD64 ModuleBase, ULONG ModuleSize, PVOID UserContext)
+{
+    wxMswEnmLddMdlsHelperStruct& alternate =
+        *(wxMswEnmLddMdlsHelperStruct*)(UserContext);
+
+    const wxWCharBuffer buf = wxConvLocal.cMB2WC(ModuleName, wxNO_LEN, NULL);
+    return (*alternate.m_pointer_to_callback)
+        (buf.data(), ModuleBase, ModuleSize, alternate.m_user_content);
+}
+
+static BOOL CALLBACK wxMswEnmLddMdlsCallback2(
+    PCSTR ModuleName, DWORD_PTR ModuleBase, ULONG ModuleSize, PVOID UserContext)
+{
+    wxMswEnmLddMdlsHelperStruct& alternate =
+        *(wxMswEnmLddMdlsHelperStruct*)(UserContext);
+
+    const wxWCharBuffer buf = wxConvLocal.cMB2WC(ModuleName, wxNO_LEN, NULL);
+    return (*alternate.m_pointer_to_callback)
+        (buf.data(), ModuleBase, ModuleSize, alternate.m_user_content);
+}
+
+#else
+
+static BOOL CALLBACK wxMswEnmLddMdlsCallback(
+    PCSTR ModuleName, DWORD_PTR ModuleBase, ULONG ModuleSize, PVOID UserContext)
+{
+    wxMswEnmLddMdlsHelperStruct& alternate =
+        *(wxMswEnmLddMdlsHelperStruct*)(UserContext);
+
+    return (*alternate.m_pointer_to_callback)
+        (ModuleName, ModuleBase, ModuleSize, alternate.m_user_content);
+}
+
+#endif // UNICODE
+
+/* static */
+BOOL wxDbgHelpDLL::EnumerateLoadedModulesT(
+    HANDLE handle, wxPENUMLOADED_MODULES_CALLBACK64 callback, PVOID pvoid)
+{
+#ifdef UNICODE
+    if (EnumerateLoadedModulesW64)
+    {
+        const BOOL retVal = (*EnumerateLoadedModulesW64)(handle, callback, pvoid);
+        if (retVal)
+            return retVal;
+    }
+    if (EnumerateLoadedModules64)
+    {
+        wxMswEnmLddMdlsHelperStruct p(callback, pvoid);
+        const BOOL retVal =
+            (*EnumerateLoadedModules64)
+                (handle, &wxMswEnmLddMdlsCallback1, (PVOID)(&p));
+        if (retVal)
+            return retVal;
+    }
+    if (EnumerateLoadedModules)
+    {
+        wxMswEnmLddMdlsHelperStruct p(callback, pvoid);
+        const BOOL retVal =
+            (*EnumerateLoadedModules)
+                (handle, &wxMswEnmLddMdlsCallback2, (PVOID)(&p));
+        if (retVal)
+            return retVal;
+    }
+    return FALSE;
+#else
+    if (EnumerateLoadedModules64)
+    {
+        const BOOL retVal = (*EnumerateLoadedModules64)(handle, callback, pvoid);
+        if (retVal)
+            return retVal;
+    }
+    if (EnumerateLoadedModules)
+    {
+        wxMswEnmLddMdlsHelperStruct p(callback, pvoid);
+        const BOOL retVal =
+            (*EnumerateLoadedModules)
+                (handle, &wxMswEnmLddMdlsCallback, (PVOID)(&p));
+        if (retVal)
+            return retVal;
+    }
+    return FALSE;
+#endif
+}
+
+/* static */
+BOOL wxDbgHelpDLL::SymInitializeT(HANDLE hProcess, LPCTSTR UserSearchPath, BOOL fInvadeProcess)
+{
+#ifdef UNICODE
+    if (SymInitializeW)
+    {
+        const BOOL retVal = (*SymInitializeW)(hProcess, UserSearchPath, fInvadeProcess);
+        if (retVal)
+            return retVal;
+    }
+    if (SymInitialize)
+    {
+        BOOL retVal;
+        if (UserSearchPath)
+        {
+            const wxCharBuffer buf = wxConvLocal.cWC2MB(UserSearchPath, wxNO_LEN, NULL);
+            retVal = (*SymInitialize)(hProcess, buf.data(), fInvadeProcess);
+        }
+        else
+        {
+            retVal = (*SymInitialize)(hProcess, NULL, fInvadeProcess);
+        }
+        return retVal;
+    }
+    return FALSE;
+#else
+    if (SymInitialize)
+    {
+        return (*SymInitialize)(hProcess, UserSearchPath, fInvadeProcess);
+    }
+    return FALSE;
+#endif
+}
+
+/* static */
+BOOL wxDbgHelpDLL::SymFromAddrT(HANDLE hProcess, DWORD64 Address, PDWORD64 Displacement, wxPSYMBOL_INFO Symbol)
+{
+#ifdef UNICODE
+    if (SymFromAddrW)
+    {
+        const BOOL retVal = (*SymFromAddrW)(hProcess, Address, Displacement, Symbol);
+        if (retVal)
+            return retVal;
+    }
+    if (SymFromAddr)
+    {
+        wxScopedPtr<BYTE> symbolBuffer(new BYTE[sizeof(SYMBOL_INFO) + Symbol->MaxNameLen*sizeof(CHAR)]);
+        PSYMBOL_INFO data = (SYMBOL_INFO*)(symbolBuffer.get());
+        wxZeroMemory(*data);
+        data->SizeOfStruct = sizeof(SYMBOL_INFO);
+        data->MaxNameLen = Symbol->MaxNameLen;
+        if (! (*SymFromAddr)(hProcess, Address, Displacement, data))
+        {
+            return FALSE;
+        }
+
+        // We can't refer data->NameLen. It seems to be unmodified.
+        const wxWCharBuffer buf = wxConvLocal.cMB2WC(data->Name, wxNO_LEN, NULL);
+        
+        Symbol->TypeIndex = data->TypeIndex;
+        Symbol->Reserved[0] = data->Reserved[0];
+        Symbol->Reserved[1] = data->Reserved[1];
+        Symbol->Index = data->Index;
+        Symbol->Size = data->Size;
+        Symbol->ModBase = data->ModBase;
+        Symbol->Flags = data->Flags;
+        Symbol->Value = data->Value;
+        Symbol->Address = data->Address;
+        Symbol->Register = data->Register;
+        Symbol->Scope = data->Scope;
+        Symbol->Tag = data->Tag;
+        Symbol->NameLen = buf.length();
+        wxStrncpy(Symbol->Name, buf.data(), Symbol->MaxNameLen);
+        return TRUE;
+    }
+    return FALSE;
+#else
+    if (SymFromAddr)
+    {
+        return (*SymFromAddr)(hProcess, Address, Displacement, Symbol);
+    }
+    return FALSE;
+#endif
+}
+
+/* static */
+BOOL wxDbgHelpDLL::SymGetLineFromAddrT(HANDLE hProcess, DWORD64 dwAddr, PDWORD pdrDisplacement, wxPIMAGEHLP_LINE Line)
+{
+#ifdef UNICODE
+    if (SymGetLineFromAddrW64)
+    {
+        const BOOL retVal = (*SymGetLineFromAddrW64)(hProcess, dwAddr, pdrDisplacement, Line);
+        if (retVal)
+            return retVal;
+        // TODO: seems always fail with GetLastError() returns 487 with 32bit binary on 64 bit Windows.
+    }
+    static WCHAR staticBuf[MAX_PATH];
+    if (SymGetLineFromAddr64)
+    {
+        IMAGEHLP_LINE64 LineAlternate;
+        LineAlternate.SizeOfStruct = sizeof(IMAGEHLP_LINE64);
+        if ((*SymGetLineFromAddr64)(hProcess, dwAddr, pdrDisplacement, &LineAlternate))
+        {
+            const wxWCharBuffer ConvBuf =
+                wxConvLocal.cMB2WC(LineAlternate.FileName, wxNO_LEN, NULL);
+            wxStrncpy(staticBuf, ConvBuf.data(), MAX_PATH);
+            Line->Key = LineAlternate.Key;
+            Line->LineNumber = LineAlternate.LineNumber;
+            Line->FileName = staticBuf;
+            Line->Address = LineAlternate.Address;
+            return TRUE;
+        }
+    }
+    if (SymGetLineFromAddr)
+    {
+        IMAGEHLP_LINE LineAlternate;
+        LineAlternate.SizeOfStruct = sizeof(IMAGEHLP_LINE);
+        if ((*SymGetLineFromAddr)(hProcess, dwAddr, pdrDisplacement, &LineAlternate))
+        {
+            const wxWCharBuffer ConvBuf =
+                wxConvLocal.cMB2WC(LineAlternate.FileName, wxNO_LEN, NULL);
+            wxStrncpy(staticBuf, ConvBuf.data(), MAX_PATH);
+            Line->Key = LineAlternate.Key;
+            Line->LineNumber = LineAlternate.LineNumber;
+            Line->FileName = staticBuf;
+            Line->Address = LineAlternate.Address;
+            return TRUE;
+        }
+    }
+    return FALSE;
+#else
+    if (SymGetLineFromAddr64)
+    {
+        return (*SymGetLineFromAddr64)(hProcess, dwAddr, pdrDisplacement, Line);
+    }
+    if (SymGetLineFromAddr)
+    {
+        IMAGEHLP_LINE LineAlternate;
+        LineAlternate.SizeOfStruct = sizeof(IMAGEHLP_LINE);
+        if ((*SymGetLineFromAddr)(hProcess, dwAddr, pdrDisplacement, &LineAlternate))
+        {
+            Line->Key = LineAlternate.Key;
+            Line->LineNumber = LineAlternate.LineNumber;
+            Line->FileName = LineAlternate.FileName;
+            Line->Address = LineAlternate.Address;
+            return TRUE;
+        }
+    }
+    return FALSE;
+#endif
+}
+
+struct wxMswSymEnumSymbolsHelperStruct
+{
+public:
+    wxMswSymEnumSymbolsHelperStruct(PSYM_ENUMERATESYMBOLS_CALLBACKW ptr, PVOID content)
+        : m_pointer_to_callback(ptr), m_user_content(content)
+    { }
+    PSYM_ENUMERATESYMBOLS_CALLBACKW m_pointer_to_callback;
+    PVOID m_user_content;
+};
+
+#ifdef UNICODE
+
+static BOOL CALLBACK wxMswSymEnumSymbolsHelperCallback(
+    PSYMBOL_INFO pSymInfo, ULONG SymbolSize, PVOID UserContext)
+{
+    wxMswSymEnumSymbolsHelperStruct& alternate =
+        *(wxMswSymEnumSymbolsHelperStruct*)(UserContext);
+    const wxWCharBuffer buf = wxConvLocal.cMB2WC(pSymInfo->Name, pSymInfo->MaxNameLen, NULL);
+    wxScopedPtr<BYTE> symbolBuffer(new BYTE[sizeof(SYMBOL_INFOW) + buf.length()*sizeof(WCHAR)]);
+    SYMBOL_INFOW* data = (SYMBOL_INFOW*)(symbolBuffer.get());
+    data->SizeOfStruct = sizeof(SYMBOL_INFOW);
+    data->TypeIndex = pSymInfo->TypeIndex;
+    data->Reserved[0] = pSymInfo->Reserved[0];
+    data->Reserved[1] = pSymInfo->Reserved[1];
+    data->Index = pSymInfo->Index;
+    data->Size = pSymInfo->Size;
+    data->ModBase = pSymInfo->ModBase;
+    data->Flags = pSymInfo->Flags;
+    data->Value = pSymInfo->Value;
+    data->Address = pSymInfo->Address;
+    data->Register = pSymInfo->Register;
+    data->Scope = pSymInfo->Scope;
+    data->Tag = pSymInfo->Tag;
+    data->NameLen = pSymInfo->NameLen;
+    data->MaxNameLen = pSymInfo->MaxNameLen;
+    wxStrncpy(data->Name, buf.data(), buf.length());
+    BOOL retVal = (*alternate.m_pointer_to_callback)(data, SymbolSize, alternate.m_user_content);
+    return retVal;
+}
+
+#endif // UNICODE
+
+/* static */
+BOOL wxDbgHelpDLL::SymEnumSymbolsT(HANDLE hProcess, ULONG64 baseOfDll, PCTSTR Mask,
+                    wxPSYM_ENUMERATESYMBOLS_CALLBACK EnumSymbolsCallback, const PVOID UserContext)
+{
+#ifdef UNICODE
+    if (SymEnumSymbolsW)
+    {
+        const BOOL retVal = (*SymEnumSymbolsW)(hProcess, baseOfDll, Mask, EnumSymbolsCallback, UserContext);
+        if (retVal)
+            return retVal;
+    }
+    if (SymEnumSymbols)
+    {
+        wxMswSymEnumSymbolsHelperStruct p(EnumSymbolsCallback, UserContext);       
+        const wxCharBuffer buf = wxConvLocal.cWC2MB(Mask ? Mask : L"", wxNO_LEN, NULL);
+        return (*SymEnumSymbols)(hProcess, baseOfDll, buf.data(),
+                                 wxMswSymEnumSymbolsHelperCallback, (PVOID)(&p));
+    }
+    return FALSE;
+#else
+    if (SymEnumSymbols)
+    {
+        return (*SymEnumSymbols)(hProcess, baseOfDll, Mask, EnumSymbolsCallback, UserContext);
+    }
+    return FALSE;
+#endif
+}
+
+// ----------------------------------------------------------------------------
 // debugging helpers
 // ----------------------------------------------------------------------------
 
@@ -780,3 +1117,4 @@
 #endif // NDEBUG
 
 #endif // wxUSE_DBGHELP
+
Index: src/msw/dlmsw.cpp
===================================================================
--- src/msw/dlmsw.cpp	(ÉäÉrÉWÉáÉì 73805)
+++ src/msw/dlmsw.cpp	(çÏã∆ÉRÉsÅ[)
@@ -2,7 +2,7 @@
 // Name:        src/msw/dlmsw.cpp
 // Purpose:     Win32-specific part of wxDynamicLibrary and related classes
 // Author:      Vadim Zeitlin
-// Modified by:
+// Modified by: Suzumizaki-kimitaka 2013-04-09
 // Created:     2005-01-10 (partly extracted from common/dynlib.cpp)
 // RCS-ID:      $Id$
 // Copyright:   (c) 1998-2005 Vadim Zeitlin <vadim@wxwindows.org>
@@ -80,15 +80,8 @@
         wxVersionDLL *verDLL;
     };
 
-    // TODO: fix EnumerateLoadedModules() to use EnumerateLoadedModules64()
-    #ifdef __WIN64__
-        typedef DWORD64 DWORD_32_64;
-    #else
-        typedef DWORD DWORD_32_64;
-    #endif
-
     static BOOL CALLBACK
-    EnumModulesProc(PCSTR name, DWORD_32_64 base, ULONG size, void *data);
+    EnumModulesProc(PCTSTR name, DWORD64 base, ULONG size, PVOID data);
 };
 
 // ============================================================================
@@ -116,7 +109,7 @@
         #endif // UNICODE/ANSI
 
         #define LOAD_VER_FUNCTION(name)                                       \
-            m_pfn ## name = (name ## _t)m_dll.GetSymbol(wxT(#name SUFFIX));    \
+            m_pfn ## name = (name ## _t)m_dll.GetSymbol(wxT(#name SUFFIX));   \
         if ( !m_pfn ## name )                                                 \
         {                                                                     \
             m_dll.Unload();                                                   \
@@ -175,17 +168,21 @@
 
 /* static */
 BOOL CALLBACK
-wxDynamicLibraryDetailsCreator::EnumModulesProc(PCSTR name,
-                                                DWORD_32_64 base,
+wxDynamicLibraryDetailsCreator::EnumModulesProc(PCTSTR name,
+                                                DWORD64 base,
                                                 ULONG size,
-                                                void *data)
+                                                PVOID data)
 {
     EnumModulesProcParams *params = (EnumModulesProcParams *)data;
 
     wxDynamicLibraryDetails *details = new wxDynamicLibraryDetails;
 
     // fill in simple properties
+#ifdef UNICODE
     details->m_name = name;
+#else
+    details->m_name = wxString(name, wxConvLocal);
+#endif
     details->m_address = wxUIntToPtr(base);
     details->m_length = size;
 
@@ -323,20 +320,14 @@
         params.dlls = &dlls;
         params.verDLL = &verDLL;
 
-        // Note that the cast of EnumModulesProc is needed because the type of
-        // PENUMLOADED_MODULES_CALLBACK changed: in old SDK versions its first
-        // argument was non-const PSTR while now it's PCSTR. By explicitly
-        // casting to whatever the currently used headers require we ensure
-        // that the code compilers in any case.
-        if ( !wxDbgHelpDLL::EnumerateLoadedModules
+        if ( !wxDbgHelpDLL::EnumerateLoadedModulesT
                             (
                                 ::GetCurrentProcess(),
-                                (PENUMLOADED_MODULES_CALLBACK)
                                 wxDynamicLibraryDetailsCreator::EnumModulesProc,
                                 &params
                             ) )
         {
-            wxLogLastError(wxT("EnumerateLoadedModules"));
+            wxLogLastError(wxT("EnumerateLoadedModulesT"));
         }
     }
 #endif // wxUSE_DBGHELP
Index: src/msw/stackwalk.cpp
===================================================================
--- src/msw/stackwalk.cpp	(ÉäÉrÉWÉáÉì 73805)
+++ src/msw/stackwalk.cpp	(çÏã∆ÉRÉsÅ[)
@@ -2,7 +2,8 @@
 // Name:        src/msw/stackwalk.cpp
 // Purpose:     wxStackWalker implementation for Win32
 // Author:      Vadim Zeitlin
-// Modified by: Artur Bac 2010-10-01 AMD64 Port
+// Modified by: Artur Bac 2010-10-01 AMD64 Port,
+//              Suzumizaki-kimitaka 2013-04-09
 // Created:     2005-01-08
 // RCS-ID:      $Id$
 // Copyright:   (c) 2003-2005 Vadim Zeitlin <vadim@wxwindows.org>
@@ -52,15 +53,15 @@
 
     // get the name of the function for this stack frame entry
     static const size_t MAX_NAME_LEN = 1024;
-    BYTE symbolBuffer[sizeof(SYMBOL_INFO) + MAX_NAME_LEN];
+    BYTE symbolBuffer[sizeof(wxSYMBOL_INFO) + MAX_NAME_LEN*sizeof(TCHAR)];
     wxZeroMemory(symbolBuffer);
 
-    PSYMBOL_INFO pSymbol = (PSYMBOL_INFO)symbolBuffer;
-    pSymbol->SizeOfStruct = sizeof(SYMBOL_INFO);
+    wxPSYMBOL_INFO pSymbol = (wxPSYMBOL_INFO)symbolBuffer;
+    pSymbol->SizeOfStruct = sizeof(wxSYMBOL_INFO);
     pSymbol->MaxNameLen = MAX_NAME_LEN;
 
     DWORD64 symDisplacement = 0;
-    if ( !wxDbgHelpDLL::SymFromAddr
+    if ( !wxDbgHelpDLL::SymFromAddrT
                         (
                             ::GetCurrentProcess(),
                             GetSymAddr(),
@@ -68,11 +69,14 @@
                             pSymbol
                         ) )
     {
-        wxDbgHelpDLL::LogError(wxT("SymFromAddr"));
+        wxDbgHelpDLL::LogError(wxT("SymFromAddrT"));
         return;
     }
-
-    m_name = wxString::FromAscii(pSymbol->Name);
+#ifdef UNICODE
+    m_name = pSymbol->Name;
+#else
+    m_name = wxString(pSymbol->Name, wxConvLocal);
+#endif
     m_offset = symDisplacement;
 }
 
@@ -84,9 +88,9 @@
     m_hasLocation = true;
 
     // get the source line for this stack frame entry
-    IMAGEHLP_LINE lineInfo = { sizeof(IMAGEHLP_LINE) };
+    wxIMAGEHLP_LINE lineInfo = { sizeof(wxIMAGEHLP_LINE) };
     DWORD dwLineDisplacement;
-    if ( !wxDbgHelpDLL::SymGetLineFromAddr
+    if ( !wxDbgHelpDLL::SymGetLineFromAddrT
                         (
                             ::GetCurrentProcess(),
                             GetSymAddr(),
@@ -96,11 +100,14 @@
     {
         // it is normal that we don't have source info for some symbols,
         // notably all the ones from the system DLLs...
-        //wxDbgHelpDLL::LogError(wxT("SymGetLineFromAddr"));
+        //wxDbgHelpDLL::LogError(wxT("SymGetLineFromAddr64"));
         return;
     }
-
-    m_filename = wxString::FromAscii(lineInfo.FileName);
+#ifdef UNICODE
+    m_filename = lineInfo.FileName;
+#else
+    m_filename = wxString(lineInfo.FileName, wxConvLocal);
+#endif
     m_line = lineInfo.LineNumber;
 }
 
@@ -126,11 +133,15 @@
     return true;
 }
 
-void wxStackFrame::OnParam(PSYMBOL_INFO pSymInfo)
+void wxStackFrame::OnParam(wxPSYMBOL_INFO pSymInfo)
 {
     m_paramTypes.Add(wxEmptyString);
 
-    m_paramNames.Add(wxString::FromAscii(pSymInfo->Name));
+#ifdef UNICODE
+    m_paramNames.Add(pSymInfo->Name);
+#else
+    m_paramNames.Add(wxString(pSymInfo->Name, wxConvLocal));
+#endif
 
     // if symbol information is corrupted and we crash, the exception is going
     // to be ignored when we're called from WalkFromException() because of the
@@ -159,7 +170,7 @@
 }
 
 BOOL CALLBACK
-EnumSymbolsProc(PSYMBOL_INFO pSymInfo, ULONG WXUNUSED(SymSize), PVOID data)
+EnumSymbolsProc(wxPSYMBOL_INFO pSymInfo, ULONG WXUNUSED(SymSize), PVOID data)
 {
     wxStackFrame *frame = static_cast<wxStackFrame *>(data);
 
@@ -196,7 +207,7 @@
         return;
     }
 
-    if ( !wxDbgHelpDLL::SymEnumSymbols
+    if ( !wxDbgHelpDLL::SymEnumSymbolsT
                         (
                             ::GetCurrentProcess(),
                             NULL,               // DLL base: use current context
@@ -205,7 +216,7 @@
                             this                // data to pass to it
                         ) )
     {
-        wxDbgHelpDLL::LogError(wxT("SymEnumSymbols"));
+        wxDbgHelpDLL::LogError(wxT("SymEnumSymbolsT"));
     }
 }
 
@@ -233,14 +244,14 @@
     // below which should be a real handle... so this is what we use
     const HANDLE hProcess = ::GetCurrentProcess();
 
-    if ( !wxDbgHelpDLL::SymInitialize
+    if ( !wxDbgHelpDLL::SymInitializeT
                         (
                             hProcess,
                             NULL,   // use default symbol search path
                             TRUE    // load symbols for all loaded modules
                         ) )
     {
-        wxDbgHelpDLL::LogError(wxT("SymInitialize"));
+        wxDbgHelpDLL::LogError(wxT("SymInitializeT"));
 
         return;
     }
@@ -383,7 +394,7 @@
     return false;
 }
 
-void wxStackFrame::OnParam(_SYMBOL_INFO * WXUNUSED(pSymInfo))
+void wxStackFrame::OnParam(wxPSYMBOL_INFO WXUNUSED(pSymInfo))
 {
 }
 
